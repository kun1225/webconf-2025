---
layout: center
transition: blur-in
---

<ChapterTitle number="3" subtitle="è¨±å¤šå·¥ç¨‹å¸«éƒ½æ²’ææ‡‚çš„" >
Effect çœŸæ­£æ„ç¾©èˆ‡é™·é˜±
</ChapterTitle>

<!--
ä»‹ç´¹å®Œ state ä»¥åŠä»–çš„å„ç¨®æ‡‰ç”¨å¾Œï¼Œé€™å€‹ç« ç¯€è¦ä»‹ç´¹çš„ä¹Ÿæ˜¯éå¸¸å¸¸ç”¨ä½†åˆä¸å®¹æ˜“ç”¨å¥½çš„ useEffect
-->

---

# ä¸€ã€Effect æ˜¯å‰¯ä½œç”¨ï¼Œä¸æ˜¯ç”Ÿå‘½é€±æœŸ

çˆ²ä»€éº¼å¾ˆå¤šäººè¦ºå¾— Effect ä¸å¥½ç”¨ï¼Ÿ

<v-click>

å› ç‚ºæœ‰å¤šäººå°‡ `useEffect` è¦–ç‚ºé¡ä¼¼ Class Component çš„ç”Ÿå‘½é€±æœŸã€‚

```jsx
useEffect(() => {
  console.log('Component did mount or userId changed');
  return () => {
    console.log('Cleanup before unmount or before userId changes again');
  };
}, [userId]);
```

</v-click>

<v-click>

å°‡ `useEffect` å°æ‡‰ Class Component çš„ç”Ÿå‘½é€±æœŸç¢ºå¯¦èƒ½å¹«æˆ‘å€‘å¿«é€Ÿä¸Šæ‰‹

<span v-mark="{color: 'var(--secondary)', at: 2}">ä½†å¯¦éš›ä¸Šæ˜¯é™åˆ¶æˆ‘å€‘å° `useEffect` çš„èªçŸ¥</span>

</v-click>

<!--
é¦–å…ˆï¼Œæœ€é‡è¦çš„è§€å¿µæ˜¯ Effect æ˜¯å‰¯ä½œç”¨ï¼Œä¸æ˜¯ç”Ÿå‘½é€±æœŸ

çˆ²ä»€éº¼å¾ˆå¤šäººè¦ºå¾— Effect ä¸å¥½ç”¨ï¼Ÿ

[click]
å› ç‚ºæœ‰éå¸¸å¤šçš„å·¥ç¨‹å¸«æœƒå°‡ useEffect è¦–ç‚ºé¡ä¼¼ Class Component çš„ç”Ÿå‘½é€±æœŸ

ç›¸ä¿¡å¾ˆå¤šäººå° effect çš„æƒ³æ³•å°±æ˜¯ï¼Œåœ¨çµ„ä»¶æ›è¼‰æˆ–å¸è¼‰å¾Œå¾ŒåŸ·è¡ŒæŸäº›ç¨‹å¼ã€‚

å°±åƒé€™å€‹ç¨‹å¼ç¢¼

åœ¨éå» class component æ™‚ï¼Œæˆ‘å€‘æœ‰ä¸€çµ„æ˜ç¢ºçš„ç”Ÿå‘½é€±æœŸå‡½å¼ï¼Œæ¯”å¦‚ componentDidMountã€componentDidUpdate å’Œ componentWillUnmountã€‚

é€™äº›å‡½å¼æä¾›äº†ä¸€å€‹æ˜ç¢ºçš„æ™‚æ©Ÿé»ä¾†åŸ·è¡ŒæŸäº›æ“ä½œã€‚

[click]
è€Œç•¶ React æ¨å‡º function component ä¸¦æ­é… useEffect æ™‚ï¼Œå¾ˆå¤šäººè‡ªç„¶æœƒæŠŠå®ƒå°æ‡‰åˆ° class component çš„é€™äº›ç”Ÿå‘½é€±æœŸä¸Šã€‚

é€™ç¨®ç†è§£æ–¹å¼é›–ç„¶åœ¨æŸäº›æƒ…æ³ä¸‹èƒ½å¹«åŠ©æˆ‘å€‘å¿«é€Ÿä¸Šæ‰‹ï¼Œä½†å¯¦éš›ä¸Šæ˜¯é™åˆ¶æˆ‘å€‘å° useEffect çš„èªçŸ¥ã€‚æ‰€ä»¥é€™å€‹ç« ç¯€ï¼Œæˆ‘æƒ³å¸¶ä½ å€‘é‡æ–°èªè­˜ useEffectï¼Œç†è§£å®ƒçš„æœ¬è³ªæ˜¯ä»€éº¼ï¼Œä»¥åŠå¦‚ä½•æ­£ç¢ºåœ°é‹ç”¨å®ƒã€‚
-->

---

# ä»€éº¼æ˜¯å‰¯ä½œç”¨

**é€™å€‹å‡½æ•¸æœƒå½±éŸ¿å¤–éƒ¨ç’°å¢ƒã€‚**

```jsx
let counter = 0;

function increment() {
  counter++; // å‰¯ä½œç”¨ï¼šä¿®æ”¹äº†å¤–éƒ¨çš„ counter è®Šæ•¸
  return counter;
}

console.log(increment()); // 1
console.log(increment()); // 2
//å› ç‚ºæ”¹è®Šäº†å…¨åŸŸè®Šæ•¸ counterï¼Œå°è‡´ç›¸åŒçš„å‘¼å«æœƒæœ‰ä¸åŒçš„çµæœ
```

<!--
åœ¨ä¸€é–‹å§‹æ¨™é¡Œå°±ç ´æ¢—äº†ï¼Œæˆ‘èªª Effect æ˜¯å‰¯ä½œç”¨ï¼Œä¸æ˜¯ç”Ÿå‘½é€±æœŸï¼Œé‚£å¾ˆå¤šäººå°±æœƒç´æ‚¶ï¼Œä»€éº¼æ˜¯å‰¯ä½œç”¨ï¼Œç°¡å–®èªªï¼šå‰¯ä½œç”¨å°±æ˜¯é€™å€‹å‡½æ•¸æœƒå½±éŸ¿å¤–éƒ¨ç’°å¢ƒï¼Œé€™é‚Šæˆ‘èˆ‰ä¸€å€‹å¾ˆç°¡å–®çš„ä¾‹å­ï¼š

æ¯”å¦‚æœ‰å€‹å…¨åŸŸè®Šæ•¸  counter ä»¥åŠä¸€å€‹å‡½æ•¸ increment()ï¼Œç„¶å¾Œæˆ‘å€‘åœ¨ increment è£¡é¢å»ä¿®æ”¹å…¨åŸŸè®Šæ•¸ counterï¼Œé€™å°±è®“é€™å€‹å‡½æ•¸æœ‰å‰¯ä½œç”¨äº†ï¼Œå› ç‚ºä»–å½±éŸ¿äº†å¤–éƒ¨ç’°å¢ƒã€‚é€™å¯èƒ½æœƒè®“ç¨‹å¼ç¢¼è®Šå¾—é›£ä»¥ç¶­è­·ï¼Œå› ç‚ºä½ ä¸æ¸…æ¥šæŸäº›å…¨åŸŸè®Šæ•¸æ˜¯ä¸æ˜¯è¢«æ”¹è®Šéäº†ã€‚
-->

---

# ç´”å‡½æ•¸ï¼ˆPure Functionï¼‰çš„å®šç¾©

Pure Functionï¼ˆç´”å‡½æ•¸ã€å‡½å¼ï¼‰æœ‰ 2 å€‹å®šç¾©

<v-clicks>

1. ç›¸åŒè¼¸å…¥æ°¸é å¾—åˆ°ç›¸åŒè¼¸å‡º
2. æ²’æœ‰å‰¯ä½œç”¨

</v-clicks>

<v-click>

```jsx
// é€™æ˜¯ä¸€å€‹ç´”å‡½æ•¸
function add(a, b) {
  return a + b;
}

// æ¯æ¬¡å‘¼å«éƒ½æœƒå¾—åˆ°ç›¸åŒçš„çµæœ
console.log(add(2, 3)); // æ°¸é æ˜¯ 5
console.log(add(2, 3)); // æ°¸é æ˜¯ 5
```

</v-click>

<!--
é€™é‚Šè¦å†ä»‹ç´¹ä¸€å€‹æ–°åè© â€” Pure Functionï¼ˆç´”å‡½æ•¸ã€å‡½å¼ï¼‰ï¼Œä»–æœ‰ 2 å€‹å®šç¾©

[click]
1. ç›¸åŒè¼¸å…¥æ°¸é å¾—åˆ°ç›¸åŒè¼¸å‡º

[click]
2. æ²’æœ‰å‰¯ä½œç”¨

[click]
æˆ‘å€‘æ‹¿é€™å€‹ç¨‹å¼ç¢¼è·Ÿä¸Šå€‹ä¾‹å­æ¯”è¼ƒä¸€ä¸‹ï¼Œå¯ä»¥ç™¼ç¾ add é€™å€‹å‡½æ•¸åªè¦å‚³å…¥çš„å€¼ç›¸åŒï¼Œè¼¸å‡ºä¹Ÿæ°¸é æœƒç›¸åŒï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œä»–ä¹Ÿæ²’æœ‰æ”¹è®Šä»»ä½•çš„å¤–éƒ¨ç’°å¢ƒï¼Œæ‰€ä»¥é€™å°±æ˜¯ä¸€å€‹ç´”å‡½æ•¸

åéä¾†èªªï¼Œæœ‰å‰¯ä½œç”¨çš„å‡½æ•¸å°±å« impure function ï¼ˆä¸ç´”çš„å‡½æ•¸ï¼‰ ï¼Œå‰é™£å­ functional programming æŒºæµè¡Œçš„ï¼Œå¦‚æœä½ æœ‰ç¨å¾®è·Ÿåˆ°é‚£æ³¢ï¼Œç›¸ä¿¡å¤šå°‘æœƒçœ‹éé€™äº›åè©ï¼Œä½†é€™é‚Šæˆ‘å€‘ä¸æ·±å…¥çš„ä»‹ç´¹ã€‚é€™é‚Šçš„é‡é»æ˜¯ä»‹ç´¹ä»€éº¼æ˜¯ effect å‰¯ä½œç”¨ã€‚
-->

---

# React Components çš„æ ¸å¿ƒï¼šPure Function

```jsx
function Counter(initCount) {
  const [count, setCount] = useState(initCount);

  return (
    <div>
      <p>{count}</p>
    </div>
  );
}
```

<v-click>

é€™å°±æ˜¯ç´”å‡½æ•¸ï¼Œ**ç›¸åŒçš„è¼¸å…¥(initCount)ï¼Œæ°¸é æœƒæ˜¯ç›¸åŒçš„è¼¸å‡ºï¼Œä¹Ÿæ²’æœ‰ä»»ä½•å‰¯ä½œç”¨**
<br/>
é€™è£¡çš„ state åªæœƒå½±éŸ¿å‡½æ•¸å…§éƒ¨ï¼Œå’Œå¤–éƒ¨æ²’æœ‰é—œè¯ã€‚

</v-click>

<v-click>

é€™ä¹Ÿæ˜¯ React çš„æ ¸å¿ƒæ€ç¶­ä¹‹ä¸€ - **Pure Function**

</v-click>

<!--
é‚£æˆ‘å€‘çŸ¥é“é€™å€‹è¦å¹¹å˜›å‘¢ï¼Ÿæˆ‘å€‘ç¨å¾®çœ‹ä¸€ä¸‹å¹³å¸¸çš„ React functionï¼š

[click]
ä½ å¯ä»¥ç™¼ç¾é€™ä¸å°±æ˜¯ç´”å‡½æ•¸å—ï¼Œç›¸åŒçš„è¼¸å…¥(initCount)ï¼Œæ°¸é æœƒæ˜¯ç›¸åŒçš„è¼¸å‡ºï¼Œä¹Ÿæ²’æœ‰ä»»ä½•å‰¯ä½œç”¨ï¼Œé€™è£¡çš„ state åªæœƒå½±éŸ¿å‡½æ•¸å…§éƒ¨ï¼Œå’Œå¤–éƒ¨æ²’æœ‰é—œè¯ã€‚

[click]
é€™ä¹Ÿæ˜¯ React çš„æ ¸å¿ƒæ€ç¶­ä¹‹ä¸€ - pure functionã€‚
-->

---

# ä½†æˆ‘å€‘çš„ç¨‹å¼ä¸€å®šæœƒæœ‰å‰¯ä½œç”¨

<v-clicks>

1. è³‡æ–™ç²å–ï¼ˆAPI å‘¼å«ï¼‰
2. äº‹ä»¶ç›£è½å™¨çš„è¨­ç½®å’Œæ¸…é™¤
3. DOM çš„ç›´æ¥æ“ä½œ
4. å®šæ™‚å™¨çš„è¨­ç½®å’Œæ¸…é™¤
5. ç€è¦½å™¨ API çš„ä½¿ç”¨ï¼ˆå¦‚ localStorageï¼‰

</v-clicks>

<v-click>

é‡é»ä¸€ç›´éƒ½<span v-mark="{color: 'var(--secondary)', at: 6}">ä¸åœ¨æ–¼é¿å…å‰¯ä½œç”¨ï¼Œè€Œæ˜¯å‰¯ä½œç”¨ç®¡ç†</span>ã€‚**ä¹Ÿæ˜¯ useEffect çš„çœŸæ­£åŠŸèƒ½**ã€‚

</v-click>

<v-click>

```jsx
useEffect(() => {
  const fetchUser = async () => {
    const response = await fetch(`/api/users/${userId}`);
    const userData = await response.json();
    setUser(userData);
  };

  fetchUser();
}, [userId]); // ä¾è³´é™£åˆ—ï¼šç•¶ userId æ”¹è®Šæ™‚é‡æ–°åŸ·è¡Œ
```

</v-click>

<!--
ä½†äº‹å¯¦ä¸Šï¼Œæˆ‘å€‘çš„ç¨‹å¼å¯ä»¥èªªä¸€å®šæ˜¯æœƒæœ‰å‰¯ä½œç”¨ï¼Œæ¯”å¦‚ï¼š

[click]
è³‡æ–™ç²å–ï¼ˆAPI å‘¼å«ï¼‰

[click]
äº‹ä»¶ç›£è½å™¨çš„è¨­ç½®å’Œæ¸…é™¤

[click]
DOM çš„ç›´æ¥æ“ä½œ

[click]
å®šæ™‚å™¨çš„è¨­ç½®å’Œæ¸…é™¤

[click]
ç€è¦½å™¨ API çš„ä½¿ç”¨ï¼ˆå¦‚ localStorageï¼‰

é€™äº›éƒ½æ˜¯å‰¯ä½œç”¨

[click]
æ‰€ä»¥æˆ‘å€‘çš„é‡é»ä¸€ç›´éƒ½ä¸åœ¨æ–¼é¿å…å‰¯ä½œç”¨ï¼Œè€Œæ˜¯å‰¯ä½œç”¨ç®¡ç†ã€‚ä¹Ÿæ˜¯ useEffect çš„çœŸæ­£åŠŸèƒ½ã€‚

[click]
å›æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘å€‘æƒ³è¦ fetch apiï¼Œæ˜¯ä¸æ˜¯éƒ½æœƒç”¨åŒ…åœ¨ useEffect å»åšï¼Œåƒé€™æ¨£
-->

---

# useEffect çš„åŸ·è¡Œæ™‚æ©Ÿ

useEffect æ˜¯ React çµ¦æˆ‘å€‘ä¸€å€‹æ–¹å¼

<v-clicks>

- åœ¨**commit phaseä¹‹å¾Œ**åšä¸€äº›å¯èƒ½å½±éŸ¿å¤–éƒ¨ä¸–ç•Œçš„äº‹æƒ…
- ä¸¦åœ¨**ä¸‹ä¸€æ¬¡ effect åŸ·è¡Œå‰**æˆ– **component unmount æ™‚**åšæ¸…ç†

</v-clicks>

<!--
æ‰€ä»¥èªª useEffect æ˜¯ React çµ¦æˆ‘å€‘ä¸€å€‹æ–¹å¼

[click]
åœ¨ã€Œcommit phase ä¹‹å¾Œã€åšä¸€äº›å¯èƒ½å½±éŸ¿å¤–éƒ¨ä¸–ç•Œçš„äº‹æƒ…

[click]
ä¸¦ä¸”åœ¨ã€Œä¸‹ä¸€æ¬¡ effect åŸ·è¡Œå‰æˆ– component unmount æ™‚ã€åšæ¸…ç†

é€™æ¨£ä¹Ÿå¾ˆåˆç†ï¼Œå› ç‚ºæˆ‘çš„ DOM ç•«é¢éƒ½å·²ç¶“æ›´æ–°å¥½äº†ï¼Œå°±å¯ä»¥æ”¾å¿ƒçš„å»åšå…¶ä»–å½±éŸ¿å¤–éƒ¨ç’°å¢ƒçš„äº‹æƒ…

é€™æ‰æ˜¯ useEffect çš„è¨­è¨ˆåˆè¡·ã€‚

èªªåˆ°é€™ï¼Œæˆ‘å€‘å¯ä»¥ä¾†ç¨å¾®çœ‹ä¸€ä¸‹ useEffect çœŸæ­£çš„åŸ·è¡Œæ™‚æ©Ÿ
-->

---

# å¯¦éš›æ¸¬è©¦ useEffect çš„åŸ·è¡Œæ™‚æ©Ÿ

````md magic-move
```jsx {*|2|4-5,19|7-14|18}
export default function Page() {
  console.log('1. render phase - call function');

  const [pCount, setPCount] = useState(0);
  const pRef = useRef(null);

  useEffect(() => {
    console.log('4. after commit - call effect');
    return () => {
      console.log('3. after commit - cleanup', pRef.current);
      // â˜ï¸ å¦‚æœ pRef.current.textContent æ˜¯æœ€æ–°çš„
      // ä»£è¡¨åœ¨ commit ä¹‹å¾Œæ‰åŸ·è¡Œ cleanup function
    };
  }, [pCount]);

  return (
    <div>
      {console.log('2. render phase - return jsx')}
      <p ref={pRef}>{`count: ${pCount}`}</p>
      <Button onClick={() => setPCount(pCount + 1)}>Count + 1</Button>
    </div>
  );
}
```
````

<!--
æˆ‘å€‘ç”¨ä¸‹é¢é€™æ®µç°¡å–®çš„ç¨‹å¼ç¢¼ä¾†è§€å¯Ÿä¸€ä¸‹æ•´å€‹æµç¨‹ï¼š

[click]
é€™å€‹ function å¾ˆç°¡å–®ï¼Œä¸€é–‹å§‹æœƒå…ˆå°å‡º 1 ç¢ºå®šçµ„ä»¶ render

[click]
ä¸¦ç”¨ä¸€å€‹ state æ§åˆ¶çµ„ä»¶ re-renderï¼Œè€Œ ref æ˜¯ç”¨å„²å­˜ä¸€å€‹ DOM å…ƒç´ ï¼ˆå±•ç¤ºä¸€ä¸‹ p å…ƒç´ çš„æ–‡å­—ï¼‰ï¼Œç”¨ä¾†è§€å¯Ÿ effect çš„åŸ·è¡Œæ™‚æ©Ÿæ˜¯åœ¨ commit ä¹‹å¾Œé‚„æ˜¯ä¹‹å‰

[click]
å¦‚æœ pRef.current.textContent æ˜¯æœ€æ–°çš„ï¼Œä»£è¡¨åœ¨ commit ä¹‹å¾Œæ‰åŸ·è¡Œ cleanup function

[click]
æœ€å¾Œå† jsx è£¡ä¹Ÿç”¨ console.log çœ‹çœ‹æ˜¯å…ˆåŸ·è¡Œ jsx é‚„æ˜¯ effect
-->

---

<Video src="/ch-2/2.mp4" />

<!--
å¾ˆæœ‰è¶£ï¼Œå¯ä»¥çœ‹åˆ°é †åºåˆ†åˆ¥æ˜¯

render phase - call function

render phase - return jsx

after commit - cleanupï¼ˆå¦‚æœæœ‰å…ˆå‰çš„ effectï¼‰

after commit - call effect

å› ç‚º pRef.current æ˜¯æœ€æ–°çš„ï¼Œé€™æ¨£å°±å¯ä»¥è­‰æ˜ effect çœŸçš„æ˜¯åœ¨ commit ä¹‹å¾Œæ‰åŸ·è¡Œ ã€‚
-->

---

# ç‚ºä»€éº¼é€™å€‹é †åºå¾ˆé‡è¦ï¼Ÿ

äº›å‰¯ä½œç”¨å¿…é ˆç­‰åˆ°ç•«é¢çœŸçš„æ›´æ–°å¾Œæ‰èƒ½åŸ·è¡Œï¼Œæ¯”å¦‚ï¼š

<v-clicks>

- è®€å– DOM çš„ä½ç½®ã€é«˜åº¦ã€æ–‡å­—ï¼ˆåƒæ˜¯ pRef.currentï¼‰
- å°å¤–è§¸ç™¼å‹•ç•«
- è¨­å®š IntersectionObserver ç­‰éœ€è¦å¯¦é«” DOM çš„æ“ä½œ

</v-clicks>

<!--
å› ç‚ºæœ‰äº›å‰¯ä½œç”¨å¿…é ˆç­‰åˆ°ç•«é¢çœŸçš„æ›´æ–°å¾Œæ‰èƒ½åŸ·è¡Œï¼Œæ¯”å¦‚ï¼š

è®€å– DOM çš„ä½ç½®ã€é«˜åº¦ã€æ–‡å­—ï¼ˆåƒæ˜¯ pRef.currentï¼‰

å°å¤–è§¸ç™¼å‹•ç•«

è¨­å®š IntersectionObserver ç­‰éœ€è¦å¯¦é«” DOM çš„æ“ä½œ

å¦‚æœä½ åœ¨ render phase å°±åŸ·è¡Œé€™äº›å‹•ä½œï¼ŒDOM é‚„æ²’æº–å‚™å¥½ï¼Œè³‡æ–™å°±æœƒä¸æº–ç¢º

é€™ç®—æ˜¯ä¸€å€‹å¾ˆç´°ç¯€çš„å°è§€å¿µï¼Œä½†äº†è§£å¾Œå°±ä¸ç”¨æ€•é¢è©¦è€ƒåˆ° useEffect äº†
-->

---
layout: center
---

# ä½ å¯èƒ½ä¸éœ€è¦ useEffect

<!--
åœ¨æˆ‘å€‘äº†è§£ useEffect çš„çœŸæ­£æ„ç¾©å¾Œï¼Œæˆ‘å€‘å°±å¯ä»¥é¿å…å¯«å‡ºä¸€äº›ä¸å¥½çš„å¯«æ³•

ä¸‹é¢åˆ†äº« 2 å€‹æˆ‘æœ€å¸¸çœ‹åˆ°èª¤ç”¨ useEffect çš„åœ°æ–¹
-->

---

# éŒ¯èª¤å ´æ™¯ä¸€ï¼šåœ¨ effect è£¡æ§åˆ¶ UI è¡Œç‚º

<v-click>

å¸Œæœ›åœ¨ Modal æ‰“é–‹æ™‚è‡ªå‹• focus è£¡é¢çš„ input

````md magic-move {at:2}
```jsx
const inputRef = useRef();

useEffect(() => {
  if (isOpen) {
    inputRef.current?.focus();
  }
}, [isOpen]);
```

```jsx
{
  open && (
    <div>
      <Input type="text" autoFocus /> {/* ğŸ‘ˆ ç›´æ¥ä½¿ç”¨ autoFocus å±¬æ€§ */}
      {/* ... */}
    </div>
  );
}
```
````

</v-click>

<!--
ç¬¬ä¸€å€‹å¸¸è¦‹çš„èª¤ç”¨æ˜¯å¾ˆå¤šäººæœƒæŠŠä¸€äº› UI æ“ä½œä¹ŸåŒ…åœ¨ useEffect è£¡ï¼Œä¾‹å¦‚ focus inputã€è·³å‡º toastï¼Œä½†é€™äº›è¡Œç‚ºå…¶å¯¦å¤§å¤šè·Ÿå‰¯ä½œç”¨ç„¡é—œã€‚

é€™äº›éœ€æ±‚çœ‹èµ·ä¾†ã€Œåƒæ˜¯å‰¯ä½œç”¨ã€ï¼Œä½†å…¶å¯¦å¾ˆå¤šæƒ…æ³ä¸‹å¯ä»¥ç”¨æ›´è‡ªç„¶çš„æ–¹å¼è™•ç†ï¼Œä¸ä¸€å®šéœ€è¦ effectã€‚

[click]
ä¾‹å¦‚æˆ‘å€‘ç¾åœ¨å¸Œæœ›åœ¨ Modal æ‰“é–‹æ™‚è‡ªå‹• focus è£¡é¢çš„ inputï¼Œæˆ‘å€‘å¯èƒ½å°±æœƒé€™æ¨£å¯«


é€™æ®µå¯«æ³•é›–ç„¶å¯è¡Œï¼Œä½†æ¯æ¬¡ isOpen æ”¹è®Šå°±æœƒè§¸ç™¼ä¸€æ¬¡ effectï¼Œå³ä½¿ input å¯èƒ½å·²ç¶“åœ¨ focus ä¸­ã€‚è€Œä¸”é‚„éœ€è¦å¤šé¤˜çš„ useEffect å’Œ useRefã€‚

[click]
é€™ç¨®å ´æ™¯ï¼Œæˆ‘å€‘å¯ä»¥ç›´æ¥ä½¿ç”¨ input è‡ªå¸¶çš„ autoFocus å±¬æ€§ã€‚é€™ç¨®å¯«æ³•æ›´ç›´è§€ä¹Ÿæ›´å¥½ç¶­è­·ã€‚
-->

---

# useEffect çš„å¦ä¸€å€‹å•é¡Œ

useEffect çš„åŸ·è¡Œæ™‚æ©Ÿæ˜¯ commit ä¹‹å¾Œï¼Œä¹Ÿå°±æ˜¯çµ„ä»¶æ›è¼‰å¾ŒåŸ·è¡Œ

<v-click>

```jsx
useEffect(() => {
  toast(`userName changed: ${userName}`);
}, [userName]);
```

</v-click>

<!--
ç”¨ useEffect æ§åˆ¶ UI é‚„æœƒç™¼ç”Ÿä¸€å€‹å•é¡Œï¼Œå› ç‚º useEffect çš„åŸ·è¡Œæ™‚æ©Ÿæ˜¯ commit ä¹‹å¾Œï¼Œä¹Ÿå°±æ˜¯çµ„ä»¶æ›è¼‰å¾ŒåŸ·è¡Œ

æ‰€ä»¥å¦‚æœæœ‰é¡ä¼¼ Tab åˆ‡æ›çš„å ´æ™¯æ™‚ï¼Œå°±æœƒå› ç‚ºçµ„ä»¶è¢«å¸è¼‰æ›è¼‰çš„é—œä¿‚ä¸æ–·åŸ·è¡Œ

èˆ‰å€‹ä¾‹å­

å‡è¨­æˆ‘å€‘æƒ³åœ¨æŸäº›ç‹€æ…‹æ”¹è®Šæ™‚è·³å‡ºæç¤ºï¼Œæ‰€ä»¥æˆ‘å€‘å¯«äº†é€™æ®µ codeï¼š
-->

---

# å•é¡Œåœ¨å“ª

<Video src="/ch-2/5-toast-error.mp4" />

<!--
ç„¶å¾Œä½ ç™¼ç¾å•é¡Œä¾†äº†ï¼æ¯æ¬¡åˆ‡æ› Tab  æ™‚ä¹Ÿæœƒè·³å‡ºä¸€æ¬¡ï¼Œé€™æ˜¯å› ç‚º useEffect æœƒåœ¨çµ„ä»¶æ›è¼‰å¾ŒåŸ·è¡Œ
-->

---

# æ­£ç¢ºå¯«æ³•ï¼šæŠŠé‚è¼¯ç¶å®šåœ¨äº‹ä»¶è™•ç†å™¨ä¸Š

````md magic-move
```jsx
useEffect(() => {
  toast(`userName changed: ${userName}`);
}, [userName]);
```

```jsx
function setNameAndShowToast(value) {
  setUserName(value);
  toast(`userName changed: ${value}`);
}
```
````

<!--
æ‰€ä»¥æ­£ç¢ºçš„åšæ³•æ‡‰è©²æ˜¯æŠŠé€™å€‹é‚è¼¯ç¶å®šåœ¨äº‹ä»¶è™•ç†å™¨ä¸Š

[click]
åƒé€™æ¨£ï¼š
-->

---

# éŒ¯èª¤å ´æ™¯äºŒï¼šåœ¨ Effect è£¡é¢å» setState

ä¸€å€‹æœå°‹åŠŸèƒ½ï¼šç•¶ä½¿ç”¨è€…æ‰“å­—æ™‚ï¼Œæœƒè§¸ç™¼ useEffect ä¾†é€²è¡Œæœå°‹ï¼Œä¸¦èª¿æ•´æœå°‹ç‹€æ…‹

````md magic-move
```jsx
const [isOpen, setIsOpen] = useState(false); // æ‰“é–‹æœå°‹åŒ¡
const [search, setSearch] = useState('');
const [results, setResults] = useState([]);
const [isSearching, setIsSearching] = useState(false);
```

```jsx
useEffect(() => {
  if (!search.trim()) {
    setResults([]); // æ¸…ç©ºçµæœ
    return;
  }

  setIsSearching(true); // è¨­ç½®æœå°‹ä¸­ç‹€æ…‹

  // å»¶é²æœå°‹ï¼Œé¿å…æ¯æ¬¡æŒ‰éµéƒ½è§¸ç™¼
  const timeout = setTimeout(() => {
    const filteredResults = blogPosts.filter((post) =>
      post.title.includes(search)
    );

    setResults(filteredResults);
    setIsSearching(false); // å–æ¶ˆæœå°‹ä¸­ç‹€æ…‹
  }, 300);

  // æ¸…ç†å‡½æ•¸
  return () => clearTimeout(timeout);
}, [search]);
```
````

<!--
å¾ˆå¤šæ™‚å€™æˆ‘å€‘æœƒæƒ³æ ¹æ“šæŸå€‹ state ä¾†å»è¨­ç½®å…¶ä»– state çš„ç‹€æ…‹ï¼Œæ¯”å¦‚ä¸€å€‹é–‹ç™¼æ™‚å¸¸è¦‹çš„æœå°‹ä¾‹å­ï¼Œæœƒæœ‰æœå°‹å­—ä¸²ã€æœå°‹çµæœä»¥åŠåƒæ˜¯æœå°‹ä¸­ç­‰ç‹€æ…‹ã€‚

ä¸¦å¯«äº†ä¸€å€‹åŸºæœ¬çš„æœå°‹åŠŸèƒ½ï¼Œç•¶ä½¿ç”¨è€…æ‰“å­—æ™‚ï¼Œæœƒè§¸ç™¼ useEffect ä¾†é€²è¡Œæœå°‹ï¼Œä¸¦èª¿æ•´æœå°‹ç‹€æ…‹ã€‚
-->

---

# åŠŸèƒ½å±•ç¤º

<Video src="/ch-2/3-search-without-init.mp4" class="!h-[400px]" />

<!--
åŸºæœ¬ä¸ŠåŠŸèƒ½æ²’å•é¡Œ

ä¸éæœ‰å€‹ä½¿ç”¨ä¸Šçš„å°å•é¡Œï¼Œç•¶æˆ‘å€‘æ‰“é–‹æœå°‹åŒ¡æ™‚ï¼Œä¸Šæ¬¡çš„æœå°‹ç´€éŒ„é‚„åœ¨ï¼Œå°è‡´æ¯æ¬¡éƒ½è¦å…ˆæ¸…ç©º
-->

---

# æ¸…ç©ºæœå°‹ç´€éŒ„

ç¾åœ¨ PM å¸Œæœ›æˆ‘å€‘åœ¨æ‰“é–‹æœå°‹åŒ¡æ™‚ï¼Œè¦æŠŠä¸Šæ¬¡çš„æœå°‹ç´€éŒ„æ¸…ç©º

<v-click>

```jsx
useEffect(() => {
  if (isOpen) {
    setSearch('');
    setResults([]);
    setIsSearching(false);
  }
}, [isOpen]);
```

</v-click>

<!--
ç¾åœ¨ PM å¸Œæœ›æˆ‘å€‘åœ¨æ‰“é–‹æœå°‹åŒ¡æ™‚ï¼Œè¦æŠŠä¸Šæ¬¡çš„æœå°‹ç´€éŒ„æ¸…ç©º

æ‰€ä»¥æˆ‘å€‘éœ€è¦å°‡ state åˆå§‹åŒ–ï¼Œæ€è€ƒä¸€ä¸‹ï¼Œä½ å€‘æœƒæ€éº¼åšå‘¢ï¼Ÿ

ç”±æ–¼é‚è¼¯æ˜¯ï¼Œæ‰“é–‹æœå°‹åŒ¡æ™‚ -> isOpen ç‚º true -> æ¸…ç©ºç´€éŒ„

[click]

å¾ˆå¤šäººç›´è¦ºæœƒç”¨ useEffectã€‚ç•¶ isOpen æ”¹è®Šæ™‚ï¼Œå»åˆå§‹åŒ–å…¶å®ƒ stateï¼Œåƒé€™æ¨£
-->

---

# å•é¡Œåœ¨å“ªï¼Ÿ

<Video src="/ch-2/4-search-with-effect.mp4"  />

<!--
åŠŸèƒ½ä¸Šæ˜¯æ²’å•é¡Œçš„ï¼Œä¸éé€™æ¨£å¯«æœƒå°è‡´å¤šé¤˜çš„ Re-renderï¼Œå¦‚æœçµ„ä»¶å…§éƒ¨æœ‰æ¯”è¼ƒæ¶ˆè€—è³‡æºçš„çµ„ä»¶ ï¼Œé‚£å°±æœƒå°è‡´ç•«é¢çš„ Lagã€‚å¦‚æœæ•´å€‹æ‡‰ç”¨ç¨‹å¼æœ‰å¤šè™•å¤šé¤˜çš„ Re-renderï¼Œé•·æœŸç´¯ç©ä¸‹ä¾†ï¼Œæ•ˆèƒ½å°±æœƒè¢«æ‹–ç´¯ã€‚
-->

---

# å¾ Effect çš„è§’åº¦ä¾†çœ‹ä¹Ÿä¸å°

æ­£ç¢ºçš„é‚è¼¯æ˜¯ï¼Œ**æ‰“é–‹æœå°‹æ¡†æ™‚ï¼Œåˆå§‹åŒ–æœå°‹ç‹€æ…‹**ã€‚

è‹¥æ˜¯ç”¨ useEffect å°±æœƒè®Šæˆï¼Œç•¶ isOpen æ”¹è®Šæ™‚ï¼Œåˆå§‹åŒ–æœå°‹ç‹€æ…‹

æœªä¾†æœ‰å…¶ä»–æœƒæ“æ§ isOpen é€™å€‹ç‹€æ…‹ï¼Œé‚£é€™å€‹ effect çš„é‚è¼¯åˆæœƒè®Šå¾—æ›´è¤‡é›œã€‚

```jsx
useEffect(() => {
  if (isOpen) {
    setSearch('');
    setResults([]);
    setIsSearching(false);
  }
}, [isOpen]);
```

<!--
è€Œå¾å‰¯ä½œç”¨çš„è§’åº¦ä¾†çœ‹ï¼Œé€™æ®µç¨‹å¼ç¢¼çš„é‚è¼¯ä¹Ÿä¸å°ã€‚

æ­£ç¢ºçš„é‚è¼¯æ˜¯ï¼Œæ‰“é–‹æœå°‹æ¡†æ™‚ï¼Œåˆå§‹åŒ–æœå°‹ç‹€æ…‹ã€‚ä½†è‹¥æ˜¯ç”¨ useEffect å°±æœƒè®Šæˆï¼Œç•¶ isOpen æ”¹è®Šæ™‚ï¼Œåˆå§‹åŒ–æœå°‹ç‹€æ…‹ï¼Œå¦‚æœæœªä¾†æœ‰å…¶ä»–æœƒæ“æ§ isOpen é€™å€‹ç‹€æ…‹ï¼Œé‚£é€™å€‹ effect çš„é‚è¼¯åˆæœƒè®Šå¾—æ›´è¤‡é›œã€‚
-->

---

# æ­£ç¢ºå¯«æ³•ï¼šæŠŠé‚è¼¯æ”¾åœ¨äº‹ä»¶è£¡

ä¾ç…§æ€è€ƒé‚è¼¯: æ‰“é–‹æœå°‹æ¡†æ™‚ &rarr; åˆå§‹åŒ–æœå°‹ç‹€æ…‹

````md magic-move
```jsx
useEffect(() => {
  if (isOpen) {
    setSearch('');
    setResults([]);
    setIsSearching(false);
  }
}, [isOpen]);
```

```jsx
// âœ… æ­£ç¢ºå¯«æ³•ï¼Œä½¿ç”¨äº‹ä»¶æ§åˆ¶ state
// å¦‚æœå’Œå¤–éƒ¨ç³»çµ±ç„¡é—œï¼Œä¸éœ€è¦ç”¨ useEffect æ§åˆ¶
const handleOpenChange = (open) => {
  setIsOpen(open);

  if (isOpen) {
    setSearch('');
    setResults([]);
    setIsSearching(false);
  }
};
```
````

<v-click at="2">

### **ç•¶ä½ ä½¿ç”¨ useEffect æ™‚ï¼Œè¨˜å¾—å¤šå•å•è‡ªå·±ï¼šé€™æ®µ code æ˜¯åœ¨é€£çµå¤–éƒ¨ç³»çµ±å—ï¼Ÿ**

</v-click>

<v-click at="3">

é‚è¼¯ä¸Šæ›´é †ï¼Œä¹Ÿå¯ä»¥æ¸›å°‘å¤šé¤˜çš„ Re-Render

</v-click>

<!--
ä¾ç…§ä¸Šçš„æ€è€ƒï¼Œæ‰“é–‹æœå°‹åŒ¡ -> åˆå§‹åŒ–æœå°‹ç‹€æ…‹ï¼Œæˆ‘å€‘æ‡‰è©²æŠŠåˆå§‹åŒ–æœå°‹ç‹€æ…‹çš„é‚è¼¯æ”¾åœ¨æ‰“é–‹æœå°‹æ¡†çš„äº‹ä»¶ä¸­ï¼Œå’Œå‰é¢ toast çš„å ´æ™¯ä¸€å„„æ¨£

[click]

ä¹Ÿå°±æ˜¯åƒä¸‹é¢é€™æ¨£ï¼š

[click]

æ‰€ä»¥æ¯ç•¶ä½ ä½¿ç”¨ useEffect æ™‚ï¼Œè¨˜å¾—å¤šå•å•è‡ªå·±ï¼šé€™æ®µ code æ˜¯åœ¨é€£çµå¤–éƒ¨ç³»çµ±å—ï¼Ÿ

[click]
é™¤äº†é‚è¼¯ä¸Šæ›´é †ï¼Œä¹Ÿå¯ä»¥æ¸›å°‘å¤šé¤˜çš„ Re-Renderï¼Œé¿å…æ•ˆèƒ½çš„å•é¡Œ

é€éé€™å€‹ä¾‹å­ï¼Œä¹Ÿè®“æˆ‘å¸¶å‡ºä¸‹å€‹ç« ç¯€çš„ä¸»é¡Œï¼šRe-render çš„å•é¡Œèˆ‡å ´æ™¯
-->
