---
layout: center
transition: blur-in
---

<ChapterTitle number="2" subtitle="å¾ state åˆ° context">
<span class="text-6xl">
4 ç¨®è§¸ç™¼ Re-render çš„å ´æ™¯
</span>
</ChapterTitle>

<!--
é›–ç„¶è§¸ç™¼ Re-render çš„æ ¹æœ¬æ˜¯ stateï¼Œä½†å¯¦éš›é–‹ç™¼æ™‚ï¼Œæœ‰å¾ˆå¤šå ´æ™¯æ˜¯æˆ‘å€‘ä¸å®¹æ˜“è¢«æ³¨æ„åˆ°
-->

---

# ä¸€ã€ä¾†è‡ª state çš„æ›´æ–° & state çš„åº•å±¤å¯¦ç¾

<ZStack>

<v-click hide>

ç•¶æˆ‘å€‘å‘¼å« setStateï¼ŒReact å°±æœƒæ¨™è¨˜è©²çµ„ä»¶éœ€è¦é‡æ–° renderã€‚

</v-click>

<div v-click="[1,2]">

å®£å‘Šå…¨å±€è®Šæ•¸ hooks ä»–æ˜¯ä¸€å€‹å„²å­˜æ‰€æœ‰ hook ç‹€æ…‹çš„é™£åˆ—ï¼ŒReact ç”¨é€™ç¨®æ–¹å¼è¨˜ä½æ¯å€‹ hook çš„å€¼ã€‚

</div>

<div v-click="[2,3]">

è¿½è¹¤ç›®å‰æ­£åœ¨åŸ·è¡Œç¬¬å¹¾å€‹ hookï¼Œ**ä¿è­‰æ¯æ¬¡ render çš„é †åºä¸€è‡´ï¼ˆé€™ä¹Ÿæ˜¯ç‚ºä»€éº¼ hook ä¸èƒ½å¯«åœ¨æ¢ä»¶åˆ¤æ–·è£¡çš„åŸå› ï¼‰**ã€‚

</div>

<div v-click="[3,4]">

ç¬¬ä¸€æ¬¡åŸ·è¡Œ useState æ™‚ï¼Œæœƒåˆå§‹åŒ– state çš„å€¼ï¼ŒReact åœ¨é€™é‚Šåˆ¤æ–·æˆ‘å€‘æ˜¯ä¸æ˜¯å‚³å…¥å‡½æ•¸

</div>

<div v-click="[4,5]">

æ¥è‘—æ›´æ–° hook çš„ä½ç½®ï¼Œè®“ä¸‹æ¬¡å‘¼å« useState æ™‚ï¼Œå¯ä»¥è™•ç†åˆ°ç›¸åŒçš„ hookã€‚ä¸¦ä¸”å›å‚³ state ä»¥åŠ setState çš„å‡½æ•¸ã€‚

</div>

<div v-click="5">

ç•¶å‘¼å« setStateï¼Œæœƒå°‡æ–°çš„å€¼å¯«å…¥å°æ‡‰çš„ `hooks[index]` ä¸­ï¼Œç„¶å¾Œè§¸ç™¼ä¸€æ¬¡ scheduleRender æº–å‚™ Re-render

</div>

</ZStack>

````md magic-move {at:1, lines: true}
```jsx {*|1|2|7-12|22-25|14-20,28-30}
let hooks = [];
let hookIndex = 0;

function useState(initialValue) {
  const currentIndex = hookIndex;

  // ç¬¬ä¸€æ¬¡ render æ™‚åˆå§‹åŒ– state
  if (hooks.length <= currentIndex) {
    hooks.push(
      typeof initialValue === 'function' ? initialValue() : initialValue
    );
  }

  const setState = (newValue) => {
    const value =
      typeof newValue === 'function' ? newValue(hooks[currentIndex]) : newValue;

    hooks[currentIndex] = value;
    scheduleRender(); // é‡æ–°æ¸²æŸ“
  };

  const state = hooks[currentIndex];
  hookIndex++;

  return [state, setState];
}

function scheduleRender() {
  render(); // æ¨¡æ“¬ React çš„é‡æ–°æ¸²æŸ“
}
```
````

<!--
æ­£å¦‚æˆ‘å€‘å‰é¢æåˆ°çš„ï¼ŒReact ä¹‹æ‰€ä»¥æœƒ re-renderï¼Œæœ€æ ¹æœ¬çš„è§¸ç™¼ä¾†æºå°±æ˜¯ state çš„è®Šå‹•ã€‚

ç•¶æˆ‘å€‘å‘¼å« setStateï¼ŒReact å°±æœƒæ¨™è¨˜è©²çµ„ä»¶éœ€è¦é‡æ–° renderã€‚åœ¨å…§éƒ¨ï¼ŒReact å¤§è‡´æœƒç¶“æ­·ä»¥ä¸‹æµç¨‹ï¼š

[click]
1. å…¨å±€è®Šæ•¸ hooks ä»–æ˜¯ä¸€å€‹å„²å­˜æ‰€æœ‰ hook ç‹€æ…‹çš„é™£åˆ—ï¼ŒReact ç”¨é€™ç¨®æ–¹å¼è¨˜ä½æ¯å€‹ hook çš„å€¼ã€‚

[click]
2. æ¥è‘—å®£å‘Š hookIndex ï¼Œä»–æ˜¯ç”¨ä¾†è¿½è¹¤ç›®å‰æ­£åœ¨åŸ·è¡Œç¬¬å¹¾å€‹ hookï¼Œä¿è­‰æ¯æ¬¡ render çš„é †åºä¸€è‡´ï¼ˆé€™ä¹Ÿæ˜¯ç‚ºä»€éº¼ hook ä¸èƒ½å¯«åœ¨æ¢ä»¶åˆ¤æ–·è£¡çš„åŸå› ï¼‰ã€‚

[click]
3. ç¬¬ä¸€æ¬¡åŸ·è¡Œ useState æ™‚ï¼Œæœƒåˆå§‹åŒ– state çš„å€¼ï¼Œé‚„è¨˜å¾—å‰é¢èªªçš„ init functionï¼ŒReact å°±æ˜¯åœ¨é€™é‚Šåˆ¤æ–·æˆ‘å€‘æ˜¯ä¸æ˜¯å‚³å…¥å‡½æ•¸çš„ï¼Œ

[click]
4. æ¥è‘—ç´€éŒ„ hook çš„å€¼ä¸¦æ›´æ–° hook çš„ä½ç½®ï¼Œè®“ä¸‹æ¬¡å‘¼å« useState æ™‚ï¼Œå¯ä»¥è™•ç†åˆ°ç›¸åŒçš„ hookã€‚ä¸¦ä¸”å›å‚³ state ä»¥åŠ setState çš„å‡½æ•¸ã€‚

[click]
5. ç•¶å‘¼å« setStateï¼Œæœƒå°‡æ–°çš„å€¼å¯«å…¥å°æ‡‰çš„ hooks[index] ä¸­ï¼Œç„¶å¾Œè§¸ç™¼ä¸€æ¬¡ scheduleRenderï¼Œè®“æ•´å€‹ component é‡æ–°åŸ·è¡Œã€‚

é›–ç„¶é€™åªæ˜¯éå¸¸ç°¡åŒ–çš„æ¨¡å‹ï¼Œä½†å®ƒèƒ½å¹«åŠ©ä½ å»ºç«‹ä¸€å€‹æ¦‚å¿µï¼š

åªè¦å‘¼å« setStateï¼Œå°±æœƒèª¿ç”¨ React çš„ re-render æ©Ÿåˆ¶ã€‚
-->

---

# åªè¦å‘¼å« setState å°±ä¸€å®šæœƒå°è‡´ re-render å—ï¼Ÿ

ä¸ä¸€å®š

<v-click>

ç•¶ React ç™¼ç¾ç¾åœ¨æ²’æœ‰å…¶ä»–æ›´æ–°è¦è™•ç†æ™‚ï¼Œ
<br/>
**å°±æœƒæå‰è¨ˆç®— setState çš„å€¼ï¼Œå¦‚æœç™¼ç¾æ–°çš„å€¼å’ŒèˆŠçš„å€¼ç›¸åŒï¼Œå°±æœƒè·³éé€™æ¬¡æ›´æ–°**ï¼Œç›´æ¥ä¸ re-renderã€‚

</v-click>

<!--
é€™è£¡è£œå……ä¸€é»ï¼š

setState ä¸€å®šæœƒå°è‡´ re-render å—ï¼Ÿ

ä¸ä¸€å®šï¼ŒReact å…§éƒ¨çš„æ©Ÿåˆ¶éå¸¸è¤‡é›œï¼Œç•¶ React ç™¼ç¾ç¾åœ¨æ²’æœ‰å…¶ä»–æ›´æ–°è¦è™•ç†æ™‚ï¼Œå°±æœƒæå‰è¨ˆç®— setState çš„å€¼ï¼Œå¦‚æœç™¼ç¾æ–°çš„å€¼å’ŒèˆŠçš„å€¼ç›¸åŒï¼Œå°±æœƒè·³éé€™æ¬¡æ›´æ–°ï¼Œç›´æ¥ä¸ re-renderã€‚

é‚„è¨˜å¾—æˆ‘å€‘åœ¨ç¬¬äºŒç« ç¯€æåˆ°é™£åˆ—å’Œç‰©ä»¶ immutable ç‰¹æ€§ï¼Œå¦‚æœæˆ‘å€‘ä¸å›å‚³æ–°çš„é™£åˆ—æˆ–ç‰©ä»¶ï¼ŒReact æœƒèªç‚ºæ˜¯ç›¸åŒçš„å€¼ï¼Œæ‰€ä»¥ä¸æœƒ re-renderã€‚

é™¤äº† immutable ä»¥å¤–ï¼Œé‚„æœ‰ä¸€éƒ¨ä»½å› æ˜¯ React çš„å…§éƒ¨å„ªåŒ–ï¼Œç•¶æˆ‘å€‘é€£çºŒ setState ç›¸åŒçš„å€¼æ™‚ï¼ŒReact æœƒè·³é re-renderã€‚
-->

---

# äºŒã€Parent è¢« Re-render

çµ„ä»¶æ˜¯ä¸€æ£µæ¨¹ï¼Œåªè¦æ¨¹ä¸ŠæŸå€‹ç¯€é»è®Šäº†ï¼Œåº•ä¸‹æ‰€æœ‰åˆ†æ”¯é è¨­éƒ½æœƒä¸€èµ·é‡æ–°è¨ˆç®—ã€‚

ä¹Ÿå°±æ˜¯èªªï¼Œ**ç•¶çˆ¶çµ„ä»¶ Re-render æ™‚ï¼Œæ‰€æœ‰çš„å­çµ„ä»¶ä¹Ÿæœƒè¢« Re-render**ï¼Œé™¤éä½¿ç”¨ React.memo ä¾†è¨˜æ†¶åŒ–

<Video src="ch-3/0-rerender.mp4" class="!h-[320px]" />

<p class="text-xs text-[var(--mute)]">å½±ç‰‡ä¾†æºï¼šhttps://react.gg/visualized#re-rendering-children</p>

<!--
é™¤äº† state æ”¹è®Šæœƒå°è‡´ re-renderï¼ŒReact ä¸­å¦ä¸€å€‹éå¸¸å¸¸è¦‹çš„ re-render ä¾†æºæ˜¯ï¼š

ç•¶çˆ¶å±¤ component é‡æ–°åŸ·è¡Œæ™‚ï¼Œæ‰€æœ‰å­ component ä¹Ÿæœƒé‡æ–°åŸ·è¡Œä¸€æ¬¡ã€‚

é€™æ˜¯ React é‹ä½œä¸­éå¸¸æ ¸å¿ƒçš„é‚è¼¯ï¼šçµ„ä»¶æ˜¯ä¸€æ£µæ¨¹ï¼Œåªè¦æ¨¹ä¸ŠæŸå€‹ç¯€é»è®Šäº†ï¼Œåº•ä¸‹æ‰€æœ‰åˆ†æ”¯é è¨­éƒ½æœƒä¸€èµ·é‡æ–°è¨ˆç®—ã€‚

å¯ä»¥åƒè€ƒé€™å€‹å½±ç‰‡

æ‰€ä»¥èªªç•¶çˆ¶çµ„ä»¶ re-render æ™‚ï¼Œå­çµ„ä»¶ä¹Ÿæœƒè¢« re-renderï¼Œé™¤éä½ ç”¨ React.memo ä¾†è¨˜æ†¶åŒ–ï¼Œé€™å€‹è¨˜æ†¶åŒ–çš„æŠ€å·§æœƒåœ¨å¾Œé¢ç« ç¯€æåˆ°
-->

---

# å­çµ„ä»¶ Re-render çš„è¿·æ€

Props çš„æ”¹è®Šä¸æœƒå°è‡´å­çµ„ä»¶ Re-renderï¼Ÿ

```jsx {*|2,7-10,16}
export default function Page() {
  let count = 0;
  console.log('Re-render Parent');

  return (
    <div>
      <button
        onClick={() => console.log(count++)}
      >{`Increment: ${count}`}</button>
      <Child count={count} />
    </div>
  );
}

function Child({ count }) {
  console.log('Re-render Child');
  return <p>{`count: ${count}`}</p>;
}
```

<!--
æ­¤å¤–ï¼Œé€™é‚Šä¹Ÿæœ‰ä¸€å€‹é—œæ–¼ re-render çš„è¿·æ€ï¼Œä½ å€‘è¦ºå¾— Props çš„æ”¹è®Šæœƒå°è‡´å­çµ„ä»¶ Re-render å—ï¼Ÿ æ€è€ƒã„§ä¸‹

å…¶å¯¦é€™å€‹è¬›æ³•æ˜¯ä¸æº–ç¢ºçš„ï¼Œçµ„ä»¶è¢« re-render å’Œ props ä¸€é»é—œä¿‚éƒ½æ²’æœ‰ï¼Œæ ¹æœ¬åŸå› é‚„æ˜¯ state çš„æ”¹è®Šã€‚

[click]
æˆ‘å€‘å‚³å…¥ä¸€å€‹ props çµ¦ childï¼Œä¸¦é€éé»æ“ŠæŒ‰éˆ•ä¾†å¢åŠ  count çš„å€¼ï¼Œçœ‹çœ‹æœƒä¸æœƒè§¸ç™¼ Child çš„ re-render
-->

---

<Video src="ch-3/1-prop-render.mp4"  />

<!--
å¯ä»¥ç™¼ç¾ä¸ç®¡æ€éº¼é»æ“Šéƒ½ä¸æœƒè§¸ç™¼ re-renderï¼Œé›–ç„¶ count çš„å€¼æœ‰æ”¹è®Šï¼Œä½† Child è£¡çš„ p count ä¸¦æ²’æœ‰æ›´æ–°ï¼Œä»£è¡¨ Child æ²’æœ‰è¢« re-renderã€‚

æ‰€ä»¥èªªå¤§å®¶ä¸€å®šè¦è¨˜ä½ï¼Œè®“ react re-render çš„ä¸€å®šæ˜¯ stateï¼Œäº†è§£é€™å€‹æœ¬è³ªå¾Œï¼Œåœ¨ä½ ç™¼ç¾æœ‰é æœŸä¹‹å¤–çš„ re-render æ™‚ä¹Ÿèƒ½æ›´å¿«é–å®šç¯„åœã€‚
-->

---

# ä¸‰ã€ä¾†è‡ª Custom Hook çš„é–“æ¥ re-render

```jsx
function useMobileHeader() {
  const [isOpen, setIsOpen] = useState(false);

  const toggle = () => setIsOpen((prev) => !prev);

  return {
    isOpen,
    toggle,
  };
}

export default function Header() {
  const { isOpen, toggle } = useMobileHeader();

  return (
    <header>
      <button onClick={toggle}>Toggle</button>
      {isOpen && <div>Mobile Header</div>}
    </header>
  );
}
```

<!--
åœ¨ React å°ˆæ¡ˆä¸­ï¼Œæˆ‘å€‘ç¶“å¸¸æœƒä½¿ç”¨ Custom Hook ä¾†æŠ½é›¢é‚è¼¯ï¼Œè®“çµ„ä»¶æ›´ç²¾ç°¡ï¼Œé€™æœ¬èº«æ˜¯ä¸€ç¨®éå¸¸è‰¯å¥½çš„åšæ³•ã€‚

ä¾‹å¦‚ä¸‹é¢é€™å€‹ useMobileHeaderï¼Œæ˜¯ä¸€å€‹ç°¡å–®æ§åˆ¶ Mobile Menu çš„ hookï¼š

é€™ç¨®æŠ½é›¢é‚è¼¯çš„æ–¹å¼ä¸åªç°¡æ½”ï¼Œä¹Ÿè®“å…ƒä»¶è·è²¬åˆ†æ˜ï¼Œæ˜¯éå¸¸æ¨è–¦çš„å¯«æ³•ã€‚
-->

---

# ç•¶ Custom Hook ä¸­åˆä½¿ç”¨äº†å…¶ä»– Hook å‘¢ï¼Ÿ

```jsx
function useScrollDirection() {
  const [direction, setDirection] = useState('up');
  const [speed, setSpeed] = useState(0);

  useEffect(() => {
    let lastScrollY = window.scrollY;
    let lastTimestamp = performance.now();

    const onScroll = () => {
      // ... è¨ˆç®—é€Ÿåº¦å’Œæ–¹å‘ ...
      setSpeed(calculatedSpeed);
      setDirection(currentY > lastScrollY ? 'down' : 'up');
    };

    window.addEventListener('scroll', onScroll);
    return () => window.removeEventListener('scroll', onScroll);
  }, []);

  return { direction, speed };
}
```

<!--
å•é¡Œä¾†äº†ï¼šç•¶ Custom Hook ä¸­åˆä½¿ç”¨äº†å…¶ä»– Hook å‘¢ï¼Ÿ

å‡è¨­æˆ‘å€‘éœ€è¦æ ¹æ“šä½¿ç”¨è€…çš„é€Ÿåº¦å’Œæ–¹å‘åšä¸€äº›ç¶²é ç‰¹æ•ˆï¼Œæ‰€ä»¥æˆ‘å€‘æ–°å¢äº†ä¸€å€‹ useScrollDirectionï¼Œå…ˆä¸ç®¡è£¡é¢çš„å¯¦ä½œæ–¹å¼ï¼Œ

ç°¡å–®èªªä»–æœƒåµæ¸¬ä½¿ç”¨è€…çš„æ»¾å‹•æ–¹å‘èˆ‡é€Ÿåº¦
-->

---

# åœ¨ `useMobileHeader` ä¸­ä½¿ç”¨ `useScrollDirection`

```jsx
function useMobileHeader() {
  useScrollDirection(); // åªæ˜¯å¼•å…¥ï¼Œä½†æ²’ç”¨ä¾†æ”¹ç•«é¢

  const [isOpen, setIsOpen] = useState(false);

  const toggle = () => setIsOpen((prev) => !prev);

  return {
    isOpen,
    toggle,
  };
}
```

Hook Aï¼ˆuseScrollDirectionï¼‰ä¸­åªè¦æœ‰ç‹€æ…‹æ›´æ–°ï¼Œå°±æœƒè®“ä½¿ç”¨å®ƒçš„ Hook Bï¼ˆuseMobileHeaderï¼‰é‡æ–°åŸ·è¡Œï¼Œè€Œå°è‡´å…ƒä»¶ re-renderã€‚

<!--
ç¾åœ¨ useMobileHeader æ”¹æˆé€™æ¨£ï¼š

è¡¨é¢ä¸Šçœ‹èµ·ä¾†æ²’ä»€éº¼å•é¡Œï¼Œä½†å¯¦éš›ä¸Šåªè¦ useScrollDirection è£¡çš„ setDirection æˆ– setSpeed è¢«è§¸ç™¼ï¼š

å³ä½¿ä½ æ²’æœ‰ä½¿ç”¨ä»»ä½•å›å‚³å€¼ï¼Œæ•´å€‹ä½¿ç”¨ useMobileHeader çš„å…ƒä»¶é‚„æ˜¯æœƒ re-renderï¼

ä¹Ÿå°±æ˜¯èªªï¼š

Hook Aï¼ˆuseScrollDirectionï¼‰ä¸­åªè¦æœ‰ç‹€æ…‹æ›´æ–°ï¼Œå°±æœƒè®“ä½¿ç”¨å®ƒçš„ Hook Bï¼ˆuseMobileHeaderï¼‰é‡æ–°åŸ·è¡Œï¼Œè€Œå°è‡´å…ƒä»¶ re-renderã€‚
-->

---

# å°±ç®— `useScrollDirection` æ²’æœ‰å›å‚³ä»»ä½•è³‡æ–™ä¹Ÿä¸€æ¨£

```jsx
function useScrollDirection() {
  // ...state & useEffect åŒä¸Š
  return null; // ğŸ§¨ å®Œå…¨æ²’å›å‚³ä»»ä½•è³‡æ–™
}
```

Custom Hook æœ¬è³ªä¸Šåªæ˜¯æ™®é€šçš„ function

useScrollDirection &rarr; useMobileHeader &rarr; Header component

Hook A çš„ç‹€æ…‹æ”¹è®Š &rarr; é‡æ–°åŸ·è¡Œ Hook B &rarr; æœ€çµ‚å°è‡´å…ƒä»¶é‡æ–° renderã€‚

<!--
å°±ç®—ä½ é€™æ¨£å¯«ï¼š

function useScrollDirection() {
// ...state & useEffect åŒä¸Š
return null; // ğŸ§¨ å®Œå…¨æ²’å›å‚³ä»»ä½•è³‡æ–™
}

çµæœä¹Ÿä¸€æ¨£ï¼ŒuseMobileHeader é‚„æ˜¯æœƒè¢«é‡æ–°åŸ·è¡Œï¼Œå› ç‚ºå®ƒè£¡é¢ã€Œå¼•ç”¨äº†æœ‰ç‹€æ…‹çš„ Hookã€ã€‚

ç‚ºä»€éº¼æœƒé€™æ¨£ï¼Ÿ

é€™å…¶å¯¦æ˜¯ React çš„é æœŸè¡Œç‚ºï¼š

Custom Hook æœ¬è³ªä¸Šåªæ˜¯æ™®é€šçš„ function

åªè¦æŸå€‹ hook ä¸­æœ‰ setStateï¼Œå®ƒå°±æœƒè§¸ç™¼å¤–å±¤ component é‡æ–°æ¸²æŸ“

è€Œé€™æ¢éˆå°±æœƒä¸€è·¯å¾€å¤–å‚³éï¼š

useScrollDirection -> useMobileHeader -> Header component

æ‰€ä»¥æˆ‘å€‘å¯ä»¥ç¸½çµç‚ºï¼š

Hook A çš„ç‹€æ…‹æ”¹è®Š â†’ é‡æ–°åŸ·è¡Œ Hook B â†’ æœ€çµ‚å°è‡´å…ƒä»¶é‡æ–° renderã€‚

é€™ç¨®æƒ…æ³ä¸å®¹æ˜“è¿½è¹¤
-->

---

# æ€éº¼è¾¦ï¼Ÿ

<v-clicks>

1. ä¸è¦åœ¨ Custom Hook ä¸­ç„¡æ„ç¾©åœ°å¼•å…¥å…¶ä»–æœ‰ç‹€æ…‹çš„ Hook
2. å¦‚æœ HookB åªæ˜¯è¦ã€Œç´€éŒ„ä¸€äº›æ•¸å€¼ã€ï¼Œå¯ä»¥è€ƒæ…®ç”¨ ref å‚³éçµæœï¼Œè€Œä¸æ˜¯ç”¨ state æ›´æ–°

</v-clicks>

<v-click>

**å°±ç®—ä½ ä¸å›å‚³ Hook çš„å€¼ï¼Œåªè¦ä½ ã€ŒåŸ·è¡Œã€å®ƒï¼Œç‹€æ…‹è®ŠåŒ–éƒ½æœƒå¼•èµ·ä¸Šå±¤ re-render**

</v-click>

<v-click>

**æ³¨æ„æ¯å€‹ state çš„æµå‹•ï¼Œé¿å…ç„¡æ„ç¾©çš„ re-render**

</v-click>

<!--
é‚£è©²æ€éº¼è¾¦ï¼Ÿ

é€™å…¶å¯¦ä¸æ˜¯ bugï¼Œä¹Ÿæ²’æœ‰ä»€éº¼ç¥å¥‡çš„è§£æ³•ï¼Œé€™æ˜¯ React çš„é æœŸè¨­è¨ˆã€‚ä½†ä½ å¯ä»¥é€™æ¨£åšä¾†æ¸›å°‘èª¤ç”¨ï¼š

[click]
1. ä¸è¦åœ¨ Custom Hook ä¸­ç„¡æ„ç¾©åœ°å¼•å…¥å…¶ä»–æœ‰ç‹€æ…‹çš„ Hook

[click]
2. åƒå‰é¢æåˆ°çš„ä¸€æ¨£å¦‚æœ HookB åªæ˜¯è¦ã€Œç´€éŒ„ä¸€äº›æ•¸å€¼ã€ï¼Œå¯ä»¥è€ƒæ…®ç”¨ ref å‚³éçµæœï¼Œè€Œä¸æ˜¯ç”¨ state æ›´æ–°

è¨˜å¾—ï¼šå°±ç®—ä½ ä¸å›å‚³ Hook çš„å€¼ï¼Œåªè¦ä½ ã€ŒåŸ·è¡Œã€å®ƒï¼Œç‹€æ…‹è®ŠåŒ–éƒ½æœƒå¼•èµ·ä¸Šå±¤ re-render

å¾ˆå¤šäººä»¥ç‚ºã€Œåªè¦ä¸ä½¿ç”¨æŸå€‹ hook çš„è³‡æ–™ï¼Œå°±ä¸æœƒå½±éŸ¿æ•ˆèƒ½ã€ï¼Œä½†é€™æ˜¯éŒ¯çš„ã€‚

æ‰€ä»¥é–‹ç™¼æ™‚ä¸€å®šè¦æœ‰é€™å€‹æ„è­˜ï¼šæ³¨æ„æ¯å€‹ state çš„æµå‹•ï¼Œé¿å…ç„¡æ„ç¾©çš„ re-render

ä¸‹ä¸€ç¯€ï¼Œæˆ‘å€‘å°‡æœƒä¾†è«‡æœ€å¾Œä¸€å€‹ç¶“å¸¸è¢«å¿½ç•¥ä½†å»éå¸¸æœ‰å½±éŸ¿çš„ re-render ä¾†æºï¼šContextã€‚
-->

---

# å››ã€Context çš„å»£æ³›å½±éŸ¿èˆ‡æ½›åœ¨é™·é˜±

Context æ˜¯ React æä¾›çš„ç‹€æ…‹å…±äº«æ©Ÿåˆ¶ï¼Œ<span v-mark="{color: 'var(--secondary)', at: 1}">è®“æˆ‘å€‘å¯ä»¥åœ¨ä¸é€é props å‚³éçš„æƒ…æ³ä¸‹ï¼Œè®“æ·±å±¤å­çµ„ä»¶å­˜å–ç‹€æ…‹ã€‚</span>

ä½†å®ƒä¹Ÿæœ‰ä¸€å€‹éå¸¸å¤§çš„å‰¯ä½œç”¨ï¼š

<v-click at="2">

**åªè¦ Context çš„å€¼æœ‰æ”¹è®Šï¼Œæ‰€æœ‰ä½¿ç”¨è©² Context çš„ Componentï¼Œéƒ½æœƒ Re-render**

</v-click>

<v-click>

ä¸ç®¡ä½ å¯¦éš›æœ‰æ²’æœ‰ç”¨åˆ°è¢«æ”¹è®Šçš„é‚£å€‹å€¼ï¼Œ**åªè¦æœ‰ç”¨ `useContext` ä½¿ç”¨ contextï¼Œé€™å€‹çµ„ä»¶å°±æœƒé‡æ–°åŸ·è¡Œ**

</v-click>

<!--
æœ€å¾Œä¸€ç¨®å¸¸è¦‹ä½†å¾ˆå®¹æ˜“è¢«å¿½ç•¥çš„ re-render ä¾†æºï¼Œå°±æ˜¯ React çš„ Contextã€‚

Context æ˜¯ React æä¾›çš„ç‹€æ…‹å…±äº«æ©Ÿåˆ¶ï¼Œè®“æˆ‘å€‘å¯ä»¥åœ¨ä¸é€é props å‚³éçš„æƒ…æ³ä¸‹ï¼Œè®“æ·±å±¤å­çµ„ä»¶å­˜å–ç‹€æ…‹ã€‚ä½†å®ƒä¹Ÿæœ‰ä¸€å€‹éå¸¸å¤§çš„å‰¯ä½œç”¨ï¼š

[click]
åªè¦ Context çš„å€¼æœ‰æ”¹è®Šï¼Œæ‰€æœ‰ä½¿ç”¨è©² Context çš„ componentï¼Œéƒ½æœƒ re-renderã€‚

[click]
è©±å¥è©±èªªä¸ç®¡ä½ å¯¦éš›æœ‰æ²’æœ‰ç”¨åˆ°è¢«æ”¹è®Šçš„é‚£å€‹å€¼ï¼Œåªè¦æœ‰ç”¨ useContext æ‹¿é contextï¼Œé€™å€‹å…ƒä»¶å°±æœƒé‡æ–°åŸ·è¡Œã€‚
-->

---

# ç°¡å–®çš„ä¾‹å­

````md magic-move {lines: true}
```jsx {*|1|3-11|13-17}
const CountContext = createContext();

function CountProvider({ children }) {
  const [count, setCount] = useState(0);

  return (
    <CountContext.Provider value={{ count, setCount }}>
      {children}
    </CountContext.Provider>
  );
}

function useCount() {
  const context = useContext(CountContext);
  if (!context) throw new Error('useCount must be used within a CountProvider');
  return context;
}
```

```jsx {*|4,12-16|5,18-21,6,24-28|7,30-33}
export default function Page() {
  return (
    <CountProvider>
      <ComponentA />
      <ComponentB />
      <ComponentC />
      <ComponentD />
    </CountProvider>
  );
}

function ComponentA() {
  console.log('Re-Render ComponentA');
  const { count } = useCount();
  return <div>{count}</div>;
}

function ComponentB() {
  console.log('Re-Render ComponentB');
  const { setCount } = useCount();
  return <button onClick={() => setCount((prev) => prev + 1)}>+1</button>;
}

function ComponentC() {
  console.log('Re-Render ComponentC');
  const { setCount } = useCount();
  return <button onClick={() => setCount((prev) => prev + 2)}>+2</button>;
}

function ComponentD() {
  console.log('Re-Render ComponentD');
  return <div>ComponentD</div>;
}
```
````

<!--
ä¾†çœ‹ä¸€å€‹ç°¡å–®çš„ç¯„ä¾‹ï¼š

[click]
å…ˆç”¨ createContext å»ºç«‹ä¸€å€‹ context

[click]
æ¥è‘—ç”¨ countProvider åŒ…ä½æ‰€æœ‰çµ„ä»¶

[click]
ä¸¦åœ¨è£¡é¢ç”¨ useCount å»ä½¿ç”¨ context

[click]
æ¥è‘—åœ¨é é¢ä¸­ï¼Œæˆ‘å€‘æ”¾äº†å¹¾å€‹ä¸åŒçš„çµ„ä»¶ï¼š

[click]
ComponentAï¼šè®€å– count

[click]
ComponentB å’Œ ComponentCï¼šåªå‘¼å« setCount

[click]
ComponentDï¼šå®Œå…¨æ²’ç”¨ context

æ€è€ƒ 5 ç§’ï¼Œç•¶ count æ”¹è®Šæ™‚ï¼Œå“ªäº›çµ„ä»¶æœƒè¢« re-render
-->

---

# å“ªäº›çµ„ä»¶æœƒé‡æ–°æ¸²æŸ“ï¼Ÿ

<v-click>

<Video src="/ch-3/2-context.mp4" />

</v-click>

<!--
å“ªäº›å…ƒä»¶æœƒé‡æ–°æ¸²æŸ“ï¼Ÿ

ç•¶ä½ æŒ‰ä¸‹æŒ‰éˆ•ï¼Œè§¸ç™¼ setCount æ™‚ï¼Œä½ å¯èƒ½æœƒä»¥ç‚ºåªæœ‰ ComponentAï¼ˆæœ‰è®€å– countï¼‰æœƒé‡æ–°æ¸²æŸ“ã€‚

ä½†å¯¦éš›ä¸Šï¼Œåªè¦ç”¨é useContext(CountContext) çš„å…ƒä»¶ï¼Œå…¨éƒ¨éƒ½æœƒ re-renderã€‚æ‰€ä»¥ï¼š

âœ… ComponentAï¼šä½¿ç”¨äº† countï¼Œre-renderï¼ˆåˆç†ï¼‰

âš ï¸ ComponentB & ComponentCï¼šåªç”¨äº† setCountï¼Œä¹Ÿæœƒ re-render 

âœ… ComponentD : å®Œå…¨æ²’ç”¨ contextï¼Œä¸å—å½±éŸ¿
-->

---

# æœ‰ä»€éº¼å•é¡Œï¼Ÿ

é€™æ¨£çš„ re-render è¡Œç‚ºå¦‚æœç™¼ç”Ÿåœ¨ç•«é¢æ¯”è¼ƒç°¡å–®çš„ UI ä¸Šï¼Œå½±éŸ¿ä¸å¤§ã€‚

ä½†å¦‚æœé€™äº› component æœ¬èº«è »è¤‡é›œçš„ï¼ˆåƒåœ–è¡¨ã€åœ–ç‰‡å‹•ç•«ã€å¤§é‡é‹ç®—ï¼‰ï¼Œå°±æœƒæ‹–æ…¢æ•´å€‹æ‡‰ç”¨æ•ˆèƒ½ã€‚

```jsx
function ComponentB() {
  console.log('Re-Render ComponentB');
  const { setCount } = useCount();

  return (
    <>
      <button onClick={() => setCount((prev) => prev + 1)}>+1</button>
      <SlowComponent delay={200} />
    </>
  );
}
```

é‡é»æ˜¯ï¼šé€™äº› Re-render æ‡‰è©²æ˜¯å¯é¿å…çš„

<!--
é‚£é€™æ¨£æœ‰ä»€éº¼å•é¡Œï¼Ÿ

é€™æ¨£çš„ re-render è¡Œç‚ºå¦‚æœç™¼ç”Ÿåœ¨ç•«é¢æ¯”è¼ƒç°¡å–®çš„ UI ä¸Šï¼Œå½±éŸ¿ä¸å¤§ã€‚ä½†å¦‚æœé€™äº› component æœ¬èº«æ˜¯è »è¤‡é›œçš„ï¼ˆåƒåŒ…å«åœ–è¡¨ã€åœ–ç‰‡å‹•ç•«ã€å¤§é‡é‹ç®—ï¼‰ï¼Œå°±æœƒæ‹–æ…¢æ•´å€‹æ‡‰ç”¨æ•ˆèƒ½ã€‚


èˆ‰ä¾‹ä¾†èªªï¼Œæˆ‘å€‘åŠ ä¸Šä¸€å€‹ SlowComponent åˆ° ComponentB è£¡ï¼š


é€™æ™‚å€™ï¼Œå³ä½¿ä½ æ˜¯æŒ‰äº† ComponentC çš„æŒ‰éˆ•ï¼Œåªå› ç‚º ComponentB ç”¨äº† contextï¼Œå®ƒä¹Ÿæœƒè¢«é‡æ–°æ¸²æŸ“ï¼ŒSlowComponent ä¹Ÿæœƒè¢«é‡æ–°åŸ·è¡Œã€‚

è€Œé€™äº› re-renderï¼Œå…¶å¯¦æœ¬ä¾†å¯ä»¥å®Œå…¨é¿å…ã€‚

æ‰€ä»¥ï¼Œé€™å’Œå‰ä¸€ç¯€ Custom Hook çš„å•é¡Œæœ¬è³ªä¸€æ¨£ï¼š

åªè¦ä½ ã€Œåƒèˆ‡ã€äº†ä¸€å€‹ç‹€æ…‹ç³»çµ±ï¼ˆä¸ç®¡æ˜¯ hook é‚„æ˜¯ contextï¼‰ï¼Œä½ å°±æœƒè¢«å®ƒçš„ re-render å‚³æŸ“ï¼Œå³ä½¿ä½ æ²’å¯¦éš›ç”¨åˆ°é‚£å€‹å€¼ã€‚

é€™ä¹Ÿæ˜¯ç‚ºä»€éº¼å¾ˆå¤šäººç”¨äº† context å»ç™¼ç¾ç•«é¢æ•ˆèƒ½è®Šå·®çš„åŸå› ã€‚


ä¸‹ä¸€ç¯€ï¼Œæˆ‘å€‘å°±æœƒæ­£å¼é€²å…¥å„ªåŒ–çš„ç« ç¯€äº†ï¼Œæœƒä¾†èŠèŠï¼š

æœ‰å“ªäº›è§€å¯Ÿ re-render çš„æ–¹æ³•ï¼Œåˆæœ‰å“ªäº›æ–¹æ³•å¯ä»¥è§£æ±ºé€™äº› re-render å•é¡Œï¼ŸåŒ…æ‹¬ useContext çš„å•é¡Œ
-->
