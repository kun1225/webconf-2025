---
layout: center
transition: blur-in
---

<ChapterTitle number="2" subtitle="å­¸æœƒé¸æ“‡åˆé©çš„ state ç®¡ç†æ–¹å¼">
å¦‚ä½•æ­£ç¢ºç®¡ç†ç‹€æ…‹
</ChapterTitle>

<!--
å¾å‰›å‰›çš„ä¾‹å­å°±çŸ¥é“ state çš„è¤‡é›œåº¦æœƒå½±éŸ¿åˆ°ç¨‹å¼ç¢¼çš„ç¶­è­·æ€§ï¼Œ

æ‰€ä»¥é€™å€‹ç« ç¯€æˆ‘æœƒè¬›ä¸€äº›å¯ä»¥ä¸ç”¨ state çš„å ´æ™¯ï¼Œä»¥åŠæˆ‘å€‘è¦å¦‚ä½•å»æ±ºå®šè¦ä¸è¦æ‹†åˆ† state é‚„æ˜¯åˆåœ¨ä¸€èµ·ç®¡ç†
-->

---

# ä¸€ã€å¾è¡¨å–®ç®¡ç†é–‹å§‹ç°¡åŒ–æ€ç¶­

åœ¨é–‹ç™¼åˆæœŸï¼Œé€šå¸¸å› ç‚ºåŠŸèƒ½ä¸è¤‡é›œï¼Œè¡¨å–®çš„æ¬„ä½ä¹Ÿä¸å¤š

````md magic-move
```jsx
const [email, setEmail] = useState('');
const [eventName, setEventName] = useState('');

return (
  {/* ... */}
  <div>
    <Label htmlFor="email">é›»å­éƒµä»¶</Label>
    <Input
      id="email"
      name="email"
      value={name}
      onChange={(e) => setEmail(e.target.value)}
      placeholder="è«‹è¼¸å…¥é›»å­éƒµä»¶"
    />
  </div>
  {/* ... */}
)
```

```jsx
const [email, setEmail] = useState('');
const [eventName, setEventName] = useState('');

const resetForm = () => {
  setEmail('');
  setEventName('');
};

return (
  {/* ... */}
  <div>
    <Label htmlFor="email">é›»å­éƒµä»¶</Label>
    <Input
      id="email"
      name="email"
      value={name}
      onChange={(e) => setEmail(e.target.value)}
      placeholder="è«‹è¼¸å…¥é›»å­éƒµä»¶"
    />
  </div>
  {/* ... */}
)
```

```jsx
// é–‹å§‹æ–°å¢ä¸€å † state
const [name, setName] = useState('');
const [phone, setPhone] = useState('');
const [email, setEmail] = useState('');
const [eventName, setEventName] = useState('');
const [people, setPeople] = useState('');
const [note, setNote] = useState('');

return ...
```

```jsx
const [name, setName] = useState('');
const [phone, setPhone] = useState('');
const [email, setEmail] = useState('');
const [eventName, setEventName] = useState('');
const [people, setPeople] = useState('');
const [note, setNote] = useState('');

const resetForm = () => {
  setName('');
  setPhone('');
  setEmail('');
  setEventName('');
  setPeople('');
  setNote('');
};

return ...
```
````

<!--
ç¬¬ä¸€å€‹ä¾‹å­ï¼Œæ˜¯ä¸€å€‹è¡¨å–®çš„åŠŸèƒ½

è¡¨å–®æ˜¯éå¸¸å¸¸è¦‹çš„å‰ç«¯çµ„ä»¶

åœ¨é–‹ç™¼åˆæœŸï¼Œé€šå¸¸å› ç‚ºåŠŸèƒ½ä¸è¤‡é›œï¼Œè¡¨å–®çš„æ¬„ä½ä¹Ÿä¸å¤šï¼Œ

æ¯”å¦‚æˆ‘æƒ³ç”¨ä¸€å€‹åƒåŠ æ´»å‹•çš„è¡¨å–®ï¼Œå°±å¯èƒ½æœƒä½¿ç”¨åƒæ˜¯ Emailã€Event ç­‰æ¬„ä½ï¼Œ

é€™æ™‚å¾ˆå¤šäººå¾€å¾€æœƒå¾ˆç›´è¦ºåœ°ç‚ºæ¯å€‹æ¬„ä½å„è‡ªè¨­ä¸€å€‹ stateã€‚

[click]
é€™ç¨®å¯«æ³•å…¶å¯¦æ²’ä»€éº¼å•é¡Œï¼Œé‚è¼¯æ¸…æ¥šã€è¦é‡ç½®è¡¨å–®ä¹Ÿå¾ˆå®¹æ˜“

[click]
ä½†éš¨è‘—éœ€æ±‚çš„è®Šå¤šï¼Œæ¬„ä½å¢åŠ ï¼Œç¨‹å¼ç¢¼ä¹Ÿé–‹å§‹è†¨è„¹

æ¯”å¦‚èªªç¾åœ¨æˆ‘è¦å¤šæœé›†å§“åã€é›»è©±ä»¥åŠå…¶å®ƒé™„è¨»äº‹é …

å¤§éƒ¨åˆ†çš„äººä¹Ÿå¯èƒ½æœƒæƒ³è¦è¶•å¿«å®ŒæˆåŠŸèƒ½ï¼Œå°±ç›´æ¥ä¸€å€‹æ¥ä¸€å€‹æ–°å¢ stateï¼Œå°è‡´æ•´å€‹è¡¨å–®çš„ state ç®¡ç†è®Šå¾—æ„ˆç™¼è¤‡é›œã€‚

[click]
é™¤äº†å¢åŠ æ›´å¤šçš„ stateï¼Œæˆ‘å€‘é‚„éœ€è¦æ›´æ”¹ä»»ä½•ç›¸é—œçš„é‚è¼¯ï¼Œä¾‹å¦‚ resetForm ä¹Ÿæœƒå› ç‚ºæ›´å¤šçš„ state å°è‡´å…§å®¹è®Šé•·

é€™æ™‚å€™è¡¨å–®çš„ç‹€æ…‹å·²ç¶“é–‹å§‹è®Šé›£ç¶­è­·äº†ã€‚
-->

---

# ç”¨ä¸€å€‹ç‰©ä»¶ç®¡ç†å…¨éƒ¨æ¬„ä½

<ZStack>

<v-click hide>

é€™é¡å‹çš„ form è¡¨å–®ï¼Œå¯ä»¥åªç”¨ä¸€å€‹ formData ä¾†é›†ä¸­ç®¡ç†æ‰€æœ‰æ¬„ä½

</v-click>

<div v-click="[1, 2]">

åˆ©ç”¨ e.target çš„æ–¹å¼å–å¾— name ä»¥åŠ valueï¼Œçµ±ä¸€ä½¿ç”¨ç›¸åŒçš„è™•ç†å‡½æ•¸

</div>

<v-click at="2">

reset çš„é‚è¼¯ä¹Ÿè®Šå¾—å¾ˆç°¡å–®ï¼Œåƒé€™æ¨£

</v-click>

</ZStack>

````md magic-move {at:1}
```jsx
const initialFormData = {
  name: '',
  phone: '',
  email: '',
  eventName: '',
  people: '',
  note: '',
};
const [formData, setFormData] = useState(initialFormData);

return (
  {/* ... */}
  <div className="space-y-2">
    <Label htmlFor="email">é›»å­éƒµä»¶</Label>
    <Input
      id="email"
      name="email"
      type="email"
      value={formData.email}
      placeholder="è«‹è¼¸å…¥é›»å­éƒµä»¶"
    />
  </div>
  {/* ... */}
)
```

```jsx {1-4,15}
const handleChange = (e) => {
  const { name, value } = e.target; // åˆ©ç”¨ e.target å–å¾— name ä»¥åŠ value
  setFormData(prev => ({ ...prev, [name]: value }));
};

return (
  {/* ... */}
  <div className="space-y-2">
    <Label htmlFor="email">é›»å­éƒµä»¶</Label>
    <Input
      id="email"
      name="email"
      type="email"
      value={formData.email}
      onChange={handleChange} // ğŸ‘ˆ åˆ©ç”¨ nameã€value ä¾†çµ±ä¸€æ›´æ–° formData
      placeholder="è«‹è¼¸å…¥é›»å­éƒµä»¶"
    />
  </div>
  {/* ... */}
)
```

```jsx {6-8}
const handleChange = (e) => {
  const { name, value } = e.target; // åˆ©ç”¨ e.target å–å¾— name ä»¥åŠ value
  setFormData(prev => ({ ...prev, [name]: value }));
};

const resetForm = () => {
  setFormData(initialFormData);
};

return (
  {/* ... */}
  <div className="space-y-2">
    <Label htmlFor="email">é›»å­éƒµä»¶</Label>
    <Input
      id="email"
      name="email"
      type="email"
      value={formData.email}
      onChange={handleChange} // ğŸ‘ˆ åˆ©ç”¨ nameã€value ä¾†çµ±ä¸€æ›´æ–° formData
      placeholder="è«‹è¼¸å…¥é›»å­éƒµä»¶"
    />
  </div>
  {/* ... */}
)


```
````

<!--
å…¶å¯¦ï¼Œå°æ–¼é€™é¡å‹çš„ form è¡¨å–®ï¼Œæˆ‘å€‘å¾ä¸€é–‹å§‹å°±å¯ä»¥åªç”¨ä¸€å€‹ formData ç‰©ä»¶ä¾†é›†ä¸­ç®¡ç†æ‰€æœ‰æ¬„ä½ï¼Œè®“ç¨‹å¼ç¢¼æ›´ç°¡æ½”ï¼Œä¹Ÿæ›´å®¹æ˜“ç¶­è­·å’Œæ“´å……ã€‚

èª’ä½†é€™æ™‚å€™å¯èƒ½å°±æœ‰äººå¥½å¥‡èªªï¼Œæˆ‘ä¸æ˜¯èªªæŠŠå…¨éƒ¨ state éƒ½å¡é€²ä¸€å€‹ç‰©ä»¶è£¡é¢ï¼Œå¯èƒ½æœƒé›£ä»¥ç¶­è­·å—ï¼Ÿ

åˆ¥æ€¥ï¼Œæˆ‘å€‘å…ˆä¾†çœ‹ä¸€ä¸‹ç‚ºä»€éº¼é€™å€‹ä¾‹å­åè€Œé©åˆé€™æ¨£åš

[click]
æ¯å€‹æ¬„ä½çš„ onChange ä¹Ÿå¯ä»¥åˆ©ç”¨ e.target çš„æ–¹å¼å–å¾— name ä»¥åŠ valueï¼Œé€™æ¨£æˆ‘å€‘å°±å¯ä»¥çµ±ä¸€ä½¿ç”¨ç›¸åŒçš„è™•ç†å‡½æ•¸

[click]
reset çš„é‚è¼¯ä¹Ÿè®Šå¾—å¾ˆç°¡å–®ï¼Œåƒé€™æ¨£
-->

---

# ä»€éº¼æ™‚å€™é©åˆé›†ä¸­ç®¡ç† stateï¼Ÿ

æ¯å€‹æ¬„ä½å½¼æ­¤ç¨ç«‹ï¼Œä¸æœƒäº’ç›¸å½±éŸ¿ï¼Œä¸€æ¬¡åªæœƒæ›´æ–°ä¸€å€‹æ¬„ä½ï¼Œä¸”å¯ä»¥ä½¿ç”¨ç›¸åŒçš„è™•ç†å‡½æ•¸

````md magic-move
```jsx
const handleChange = (e) => {
  const { name, value } = e.target;
  setFormData((prevData) => ({
    ...prevData,
    [name]: value,
  }));
};
```

```jsx {16}
const handleChange = (e) => {
  const { name, value } = e.target;
  setFormData((prevData) => ({
    ...prevData,
    [name]: value,
  }));
};

<div className="space-y-2">
  <Label htmlFor="email">é›»å­éƒµä»¶</Label>
  <Input
    id="email"
    name="email"
    type="email"
    value={email}
    onChange={(e) => setEmail(e.target.value)}
    placeholder="è«‹è¼¸å…¥é›»å­éƒµä»¶"
  />
</div>;
```

```jsx {16}
const handleChange = (e) => {
  const { name, value } = e.target;
  setFormData((prevData) => ({
    ...prevData,
    [name]: value,
  }));
};

<div className="space-y-2">
  <Label htmlFor="email">é›»å­éƒµä»¶</Label>
  <Input
    id="email"
    name="email"
    type="email"
    value={email}
    onChange={handleChange}
    placeholder="è«‹è¼¸å…¥é›»å­éƒµä»¶"
  />
</div>;
```

```jsx
const updateState = (key, value) => {
  setState((prev) => ({ ...prev, [key]: value }));
};

<button onClick={() => updateState('email', 'test@example.com')}>
  æ›´æ–° email
</button>;
```
````

<!--
é‚£åˆ°åº•ä»€éº¼æ™‚å€™é©åˆé›†ä¸­ç®¡ç† stateï¼Ÿ

æ¯å€‹æ¬„ä½å½¼æ­¤ç¨ç«‹ï¼Œä¸æœƒäº’ç›¸å½±éŸ¿ï¼Œä¹Ÿå°±æ˜¯èªªä¸€æ¬¡åªæœƒæ›´æ–°ä¸€å€‹æ¬„ä½ï¼Œä¸”å¯ä»¥ä½¿ç”¨ç›¸åŒçš„è™•ç†å‡½æ•¸

form è¡¨å–®æ˜¯æœ€é©åˆé€™ç¨®æ–¹å¼çš„ï¼Œå°¤å…¶æ˜¯åœ¨ä¸éœ€è¦è¤‡é›œé©—è­‰æ©Ÿåˆ¶çš„æƒ…æ³ä¸‹ï¼ŒåŸå› æ˜¯æˆ‘å€‘èƒ½é€é event ç‰©ä»¶ä¾†æ‹¿åˆ°è³‡æ–™

[click]
ä¸éœ€è¦é¡å¤–å»å¯«å…¶ä»– setState å‡½æ•¸

[click]
ç›´æ¥ä½¿ç”¨ handleChange å°±å¥½ï¼Œéå¸¸å„ªé›…

[click]
åœ¨å…¶å®ƒå ´åˆï¼Œæˆ‘å€‘ä¹Ÿèƒ½å¤ éé€™ç¨®å¯«æ³•åšåˆ°é¡ä¼¼çš„äº‹æƒ…ä¾†ç°¡åŒ–é‚è¼¯

æ‰€ä»¥å¦‚æœä½ ç™¼ç¾æ¯å€‹ state å½¼æ­¤ç¨ç«‹ï¼Œä¸æœƒäº’ç›¸å½±éŸ¿ï¼Œä¸€æ¬¡åªæœƒæ›´æ–°ä¸€å€‹æ¬„ä½ï¼Œå°±å¯ä»¥è€ƒæ…®é›†ä¸­ state ä¾†ç°¡åŒ–é‚è¼¯
-->

---
layout: two-cols-header
---

# é€™ä¸æ˜¯è¬ç”¨è§£

::left::

åœ¨ä½¿ç”¨ä¸€äº› UI libraryï¼ˆåƒ shadcnï¼‰æ™‚è¦æ³¨æ„

shadcn select çš„ onValueChange åªå›å‚³ä¸€å€‹ value
è€Œä¸æ˜¯ event object æ‹¿ä¸åˆ° name è·Ÿ valueï¼Œé€™å€‹å¯«æ³•å°±æœƒå‡ºéŒ¯

::right::

<img src="/ch-2/shadcn-select.png" alt="shadcn select" />

::bottom::

```jsx
<Select
  name="..."
  onValueChange={handleChange} // âŒ é€™è£¡å°±æŠ“ä¸åˆ° name
/>
```

<!--
ä¸éé€™ä¸æ˜¯è¬éˆä¸¹å•Š

åœ¨ä½¿ç”¨ä¸€äº› UI libraryï¼ˆåƒ shadcnï¼‰æ™‚ï¼Œå°±è¦æ³¨æ„ api æœ‰æ²’æœ‰æ”¹è®Š

ä»¥ shadcn çš„ select ä¾†çœ‹

å¯ä»¥çœ‹åˆ°ï¼Œshadcn select çš„ onValueChange åªå›å‚³ä¸€å€‹ valueï¼Œè€Œä¸æ˜¯ event objectï¼Œæ‰€ä»¥åœ¨ handleChange ä¸­ä¹Ÿå°±æ‹¿ä¸åˆ° name è·Ÿ valueï¼Œæ‰€ä»¥é€™å€‹å¯«æ³•å°±æœƒå‡ºéŒ¯
-->

---

å¯ä»¥ä¾ç…§åœ˜éšŠè¦ç¯„ï¼Œçœ‹è¦å›æ­¸åŸæœ¬å¾ˆå¤š state çš„åšæ³•
é‚„æ˜¯ç¨å¾®ä¿®æ”¹ select çµ„ä»¶ï¼Œçµ±ä¸€æ¥å£

```jsx {*|5-13}
function Select({ name, onValueChange, ...props }) {
  return (
    <SelectPrimitive.Root
      data-slot="select"
      onValueChange={(val) => {
        const fakeEvent = {
          target: {
            name,
            value: val,
          },
        };
        onValueChange(fakeEvent);
      }}
      {...props}
    />
  );
}
```

<!--
é€™ç¨®æƒ…æ³æˆ‘å€‘å¯ä»¥ä¾ç…§åœ˜éšŠè¦ç¯„ï¼Œçœ‹è¦å›æ­¸åŸæœ¬å¾ˆå¤š state çš„åšæ³•ï¼Œé‚„æ˜¯ç¨å¾®ä¿®æ”¹ select çµ„ä»¶ï¼Œçµ±ä¸€æ¥å£

[click]
æ¯”å¦‚èªªé€™è£¡ï¼Œç›´æ¥ä¿®æ”¹ shadcn çš„ select çµ„ä»¶çš„ onValueChangeï¼Œè®“ä»–å›å‚³ä¸€å€‹å‡çš„ event object ä»¥æ­¤ä¾†çµ±ä¸€æ¥å£

ä¸éæˆ‘ä¸¦ä¸æ˜¯éå¸¸æ¨è–¦é€™æ¨£åšï¼Œé€™å¾ˆä¾è³´åœ˜éšŠçš„ç®¡ç†å’Œè¦ç¯„ï¼Œå¦‚æœåœ˜éšŠæ²’æœ‰æ˜ç¢ºè¦ç¯„ï¼Œå¯èƒ½æœƒå°è‡´ codebase è®Šå¾—é›£ä»¥ç¶­è­·
-->

---

# æœ‰äº›æƒ…æ³ç”šè‡³ä¸éœ€è¦ useState

å¦‚æœåªåœ¨é€å‡ºè¡¨å–®æ™‚æ‰éœ€è¦æ‹¿åˆ°è³‡æ–™ï¼Œ**ä¸éœ€è¦å³æ™‚æ›´æ–°ç•«é¢ï¼Œé‚£å…¶å¯¦å¯ä»¥å®Œå…¨ä¸ä½¿ç”¨ useStateã€‚**

React 18 å° form æ“´å……çš„åŠŸèƒ½ï¼Œè®“ `<form action={...}>` å¯ä»¥æ¥å—ä¸€å€‹ Function

é€™å€‹ Function å¯ä»¥æ‹¿åˆ° `formData`

````md magic-move
```jsx {*|2-3}
const handleSubmit = (formData) => {
  const data = Object.fromEntries(formData);
  // â˜ï¸ å°‡ FormData ç‰©ä»¶è½‰æ›ç‚ºæ™®é€š JavaScript ç‰©ä»¶ä¾†æ‹¿åˆ°å®Œæ•´çš„è³‡æ–™
  console.log(data);
};

<form action={handleSubmit}>{/* ... */}</form>;
```

```jsx
const handleSubmit = (formData) => {
  const name = formData.get('name');
  // â˜ï¸ ä¹Ÿå¯ä»¥é€é get æ‹¿åˆ°å–®ä¸€æ¬„ä½è³‡æ–™
  console.log(name);
};

<form action={handleSubmit}>{/* ... */}</form>;
```
````

<v-click at="3">

å¦‚æœé€™å€‹è¡¨å–®è³‡æ–™**ä¸éœ€è¦æ¸²æŸ“ç•«é¢ï¼Œåªæœ‰åœ¨é€å‡ºæ™‚æœƒç”¨åˆ°**ï¼Œ

é‚£é€™å€‹æ™‚å€™ç”šè‡³**ä¸éœ€è¦ stateï¼Œç›´æ¥ä½¿ç”¨ `action` å’Œ `formData` å³å¯**

</v-click>

<!--
å¦‚æœåªåœ¨é€å‡ºè¡¨å–®æ™‚æ‰éœ€è¦æ‹¿åˆ°è³‡æ–™ï¼Œ**ä¸éœ€è¦å³æ™‚æ›´æ–°ç•«é¢ï¼Œé‚£å…¶å¯¦å¯ä»¥å®Œå…¨ä¸ä½¿ç”¨ useStateã€‚**

React 18 å° form æ“´å……çš„åŠŸèƒ½ï¼Œè®“ `<form action={...}>` å¯ä»¥æ¥å—ä¸€å€‹ functionï¼Œé€™å€‹ function å¯ä»¥æ‹¿åˆ°å®Œæ•´çš„ FormDataï¼š

[click]
æ‰€ä»¥æˆ‘å€‘å¯ä»¥åˆ©ç”¨ Object.fromEntries å°‡ FormData è½‰æ›ç‚ºæ™®é€š JavaScript ç‰©ä»¶ä¾†æ‹¿åˆ°å®Œæ•´çš„è³‡æ–™

(æœ‰äººå•å†èªª:å¦‚æœè¦ç›´æ¥å‚³ formData åˆ°å¾Œç«¯ï¼ŒContent-Type è¦ç”¨ multipart/form-dataï¼Œ)

[click]
ä¹Ÿå¯ä»¥é€é formData.get æ‹¿åˆ°å–®ä¸€æ¬„ä½è³‡æ–™

[click]
ä¹Ÿå°±æ˜¯èªªï¼Œå¦‚æœé€™å€‹è¡¨å–®ä¸éœ€è¦å³æ™‚æ¸²æŸ“ç•«é¢ï¼Œåªæœ‰åœ¨é€å‡ºæ™‚éœ€è¦ç”¨åˆ°

é‚£é€™å€‹æ™‚å€™ç”šè‡³ä¸éœ€è¦ stateï¼Œç›´æ¥ä½¿ç”¨ action å³å¯

é™¤äº†ä¸ç”¨ stateï¼Œå¦ä¸€å€‹å¥½è™•æ˜¯å¯ä»¥åœ¨ Server Component å»ä½¿ç”¨
-->

---

# äºŒã€ç”¨ ref å–ä»£ state è®“é‚è¼¯æ›´ä¹¾æ·¨

é™¤äº† formDataï¼Œå…¶ä»–ä¸å½±éŸ¿ç•«é¢çš„è³‡æ–™ï¼Œä¹Ÿå¯ä»¥ç”¨ ref ä¾†å„²å­˜

### ref ä¸åªèƒ½ç”¨ä¾†å„²å­˜ DOM ç¯€é»

å®ƒæ›´åƒæ˜¯ä¸€å€‹å¯ä»¥åœ¨æ¯æ¬¡é‡æ–°æ¸²æŸ“æœŸé–“ï¼Œ**ä¿æŒè³‡æ–™ä¸€è‡´çš„å®¹å™¨**

### `useRef` vs `useState`

- state çš„è®Šæ›´æœƒè§¸ç™¼çµ„ä»¶é‡æ–°æ¸²æŸ“
- ref å‰‡åªæ˜¯ç”¨ä¾†å„²å­˜è³‡æ–™ï¼Œè®Šæ›´æ™‚ä¸æœƒå°è‡´ Re-renderï¼Œ**è€Œä¸”èƒ½åœ¨å¤šæ¬¡æ¸²æŸ“é–“ä¿ç•™å€¼**

<!--
é™¤äº† formDataï¼Œå…¶ä»–ä¸å½±éŸ¿ç•«é¢çš„è³‡æ–™ï¼Œä¹Ÿå¯ä»¥ç”¨ ref ä¾†å„²å­˜

æœ‰äº›åˆå­¸è€…æœƒèª¤ä»¥ç‚º useRef åªèƒ½ç”¨ä¾†å„²å­˜ DOM ç¯€é»ã€‚

äº‹å¯¦ä¸Šï¼Œå®ƒæ›´åƒæ˜¯ä¸€å€‹å¯ä»¥åœ¨æ¯æ¬¡é‡æ–°æ¸²æŸ“æœŸé–“ï¼Œä¿æŒè³‡æ–™ä¸€è‡´çš„å®¹å™¨ï¼Œé©åˆç”¨æ–¼å„²å­˜é‚£äº›ä¸éœ€è¦è§¸ç™¼ç•«é¢æ›´æ–°çš„è³‡æ–™ã€‚

useRef èˆ‡ useState çš„æœ€å¤§å·®ç•°åœ¨æ–¼ï¼š

- state çš„è®Šæ›´æœƒè§¸ç™¼å…ƒä»¶é‡æ–°æ¸²æŸ“ã€‚é€™å€‹æˆ‘å€‘å·²ç¶“çŸ¥é“äº†
- ref å‰‡åªæ˜¯ç”¨ä¾†å„²å­˜è³‡æ–™ï¼Œè®Šæ›´ä¸æœƒå°è‡´ re-renderï¼Œä¸”èƒ½åœ¨å¤šæ¬¡æ¸²æŸ“é–“ä¿ç•™å…¶å€¼ã€‚

æˆ‘å€‘ç›´æ¥ä¾†çœ‹ä¾‹å­
-->

---

# å„²å­˜æ­·å²ç´€éŒ„çš„éœ€æ±‚

PM å¸Œæœ›æˆ‘å€‘èƒ½å¤ è®“ä½¿ç”¨è€…é»é¸æ¨™ç±¤å¾Œå¯ä»¥æŒ‰ä¸‹ Ctrl+Z è¿”å›ä¸Šä¸€æ­¥

<Video class="!h-[400px]">
<source src="/ch-2/1.mp4" type="video/mp4" />
</Video>

<!--
æˆ‘å€‘å…ˆä¾†çœ‹ä¸€å€‹éœ€æ±‚

PM å¸Œæœ›æˆ‘å€‘èƒ½å¤ è®“ä½¿ç”¨è€…é»é¸æ¨™ç±¤å¾Œå¯ä»¥æŒ‰ä¸‹ Ctrl+Z å›å¾©ä¸Šä¸€æ­¥ã€‚

é€™æ˜¯å¾ˆå¤šç·¨è¼¯å™¨éƒ½æœ‰çš„åŠŸèƒ½
-->

---

# ç”¨ state å¯¦ä½œ

åŸæœ¬å·¥ç¨‹å¸«çš„å¯«æ³•æ˜¯ç”¨ state è¨˜éŒ„æ•´å€‹æ­·å²ï¼š

````md magic-move {at:1}
```jsx
const [selectedTags, setSelectedTags] = useState([]);
const [_, setHistory] = useState([]); // ä½¿ç”¨ state è¨˜éŒ„æ•´å€‹æ­·å²
```

```jsx {2-3|4,6-13|14|15-26}
const handleTagClick = (tag) => {
  // æª¢æŸ¥è©²æ¨™ç±¤æ˜¯å¦å·²ç¶“è¢«é¸ä¸­
  if (!selectedTags.includes(tag)) {
    setSelectedTags((prev) => [...prev, tag]); // å¦‚æœæ¨™ç±¤æœªè¢«é¸ä¸­ï¼Œå‰‡å°‡å…¶åŠ å…¥é¸ä¸­åˆ—è¡¨

    // è¨˜éŒ„ã€Œæ–°å¢ã€æ“ä½œåˆ°æ­·å²ç´€éŒ„ä¸­
    setHistory((prev) => [
      ...prev,
      {
        type: 'add', // æ“ä½œé¡å‹ï¼šæ–°å¢
        tag, // è¢«æ“ä½œçš„æ¨™ç±¤
      },
    ]);
  } else {
    setSelectedTags(
      (prev) => prev.filter((t) => t !== tag) // å¦‚æœæ¨™ç±¤å·²è¢«é¸ä¸­ï¼Œå‰‡å°‡å…¶å¾é¸ä¸­åˆ—è¡¨ä¸­ç§»é™¤
    );

    // è¨˜éŒ„ã€Œç§»é™¤ã€æ“ä½œåˆ°æ­·å²ç´€éŒ„ä¸­
    setHistory((prev) => [
      ...prev,
      {
        type: 'remove', // æ“ä½œé¡å‹ï¼šç§»é™¤
        tag, // è¢«æ“ä½œçš„æ¨™ç±¤
      },
    ]);
  }
};
```

```jsx {*|3-7|9-19|14-15,17-18|21-22}
useEffect(() => {
  const handleKeyDown = (e) => {
    const isCtrlZ = (e.ctrlKey || e.metaKey) && e.key === 'z';

    if (isCtrlZ) {
      setHistory((prev) => {
        if (prev.length === 0) return prev;

        // å–å¾—æœ€å¾Œä¸€æ¬¡æ“ä½œ
        const lastAction = prev[prev.length - 1];

        // æ ¹æ“šæœ€å¾Œä¸€æ¬¡æ“ä½œçš„é¡å‹ï¼ŒåŸ·è¡Œç›¸åçš„æ“ä½œ
        if (lastAction.type === 'add') {
          // å¦‚æœæœ€å¾Œä¸€æ¬¡æ˜¯æ–°å¢ï¼Œæ’¤éŠ·æ™‚è¦ç§»é™¤è©²æ¨™ç±¤
          setSelectedTags((tags) => tags.filter((t) => t !== lastAction.tag));
        } else if (lastAction.type === 'remove') {
          // å¦‚æœæœ€å¾Œä¸€æ¬¡æ˜¯ç§»é™¤ï¼Œæ’¤éŠ·æ™‚è¦é‡æ–°åŠ å…¥è©²æ¨™ç±¤
          setSelectedTags((tags) => [...tags, lastAction.tag]);
        }

        // ç§»é™¤æ­·å²ç´€éŒ„ä¸­çš„æœ€å¾Œä¸€ç­†æ“ä½œï¼ˆç­‰åŒæ–¼ popï¼‰
        return prev.slice(0, -1);
      });
    }
  };

  window.addEventListener('keydown', handleKeyDown);

  return () => window.removeEventListener('keydown', handleKeyDown);
}, []);
```
````

<!--
åŸæœ¬å·¥ç¨‹å¸«çš„å¯«æ³•æ˜¯ç”¨ state è¨˜éŒ„æ•´å€‹æ­·å²
æˆ‘å€‘å…ˆçœ‹ä¸€ä¸‹åŸæœ¬çš„åšæ³•

[click]
å¦‚æœæ¨™ç±¤é‚„æ²’è¢«é¸å–

[click]
è¦å…ˆè¨­ç½® selectedTag ä»¥åŠ historyï¼Œä¹Ÿè¦è¨˜éŒ„é€™å€‹æ“ä½œæ˜¯æ–°å¢æ¨™ç±¤

[click]
å¦‚æœæ¨™ç±¤å·²ç¶“è¢«è¢«é¸å–

[click]
ä»£è¡¨è¦å–æ¶ˆé¸å–é€™å€‹æ¨™ç±¤ï¼Œä¸¦è¨˜éŒ„â€œåˆªé™¤â€çš„æ­·å²æ“ä½œ

--

[click]
é™¤æ­¤ä¹‹å¤–å•Šï¼Œæˆ‘å€‘é‚„è¦ç”¨ useEffect ä¾†ç¶å®šæŒ‰éµäº‹ä»¶

[click]
å¦‚æœä½¿ç”¨è€…æ˜¯æŒ‰ ctrl + z çš„è©±ï¼Œæˆ‘å€‘è¦å…ˆåˆ¤æ–·æœ‰æ²’æœ‰æ­·å²æ“ä½œï¼Œæ²’æœ‰çš„è©±å°±å¿½ç•¥

[click]
æœ‰çš„æˆ‘å€‘è¦å¾æ­·å²ç´€éŒ„ä¸­å–å¾—æœ€å¾Œä¸€æ¬¡æ“ä½œï¼Œä¸¦åŸ·è¡Œç›¸åçš„æ“ä½œ

[click]
åŒæ™‚ï¼Œé‚„è¦ setSelectedTags ä¾†æ›´æ–°æ¨™ç±¤

[click]
æœ€å¾Œï¼Œç§»é™¤æ­·å²ç´€éŒ„ä¸­çš„æœ€å¾Œä¸€ç­†æ“ä½œ
-->

---

# æœ‰å“ªäº›å•é¡Œï¼Ÿ

````md magic-move
```jsx {*|6-13,19-26}
const handleTagClick = (tag) => {
  // æª¢æŸ¥è©²æ¨™ç±¤æ˜¯å¦å·²ç¶“è¢«é¸ä¸­
  if (!selectedTags.includes(tag)) {
    setSelectedTags((prev) => [...prev, tag]); // å¦‚æœæ¨™ç±¤æœªè¢«é¸ä¸­ï¼Œå‰‡å°‡å…¶åŠ å…¥é¸ä¸­åˆ—è¡¨

    // è¨˜éŒ„ã€Œæ–°å¢ã€æ“ä½œåˆ°æ­·å²ç´€éŒ„ä¸­
    setHistory((prev) => [
      ...prev,
      {
        type: 'add', // æ“ä½œé¡å‹ï¼šæ–°å¢
        tag, // è¢«æ“ä½œçš„æ¨™ç±¤
      },
    ]);
  } else {
    setSelectedTags(
      (prev) => prev.filter((t) => t !== tag) // å¦‚æœæ¨™ç±¤å·²è¢«é¸ä¸­ï¼Œå‰‡å°‡å…¶å¾é¸ä¸­åˆ—è¡¨ä¸­ç§»é™¤
    );

    // è¨˜éŒ„ã€Œç§»é™¤ã€æ“ä½œåˆ°æ­·å²ç´€éŒ„ä¸­
    setHistory((prev) => [
      ...prev,
      {
        type: 'remove', // æ“ä½œé¡å‹ï¼šç§»é™¤
        tag, // è¢«æ“ä½œçš„æ¨™ç±¤
      },
    ]);
  }
};
```

```jsx {6,13-19|21-22}
useEffect(() => {
  const handleKeyDown = (e) => {
    const isCtrlZ = (e.ctrlKey || e.metaKey) && e.key === 'z';

    if (isCtrlZ) {
      setHistory((prev) => {
        if (prev.length === 0) return prev;

        // å–å¾—æœ€å¾Œä¸€æ¬¡æ“ä½œ
        const lastAction = prev[prev.length - 1];

        // æ ¹æ“šæœ€å¾Œä¸€æ¬¡æ“ä½œçš„é¡å‹ï¼ŒåŸ·è¡Œç›¸åçš„æ“ä½œ
        if (lastAction.type === 'add') {
          // å¦‚æœæœ€å¾Œä¸€æ¬¡æ˜¯æ–°å¢ï¼Œæ’¤éŠ·æ™‚è¦ç§»é™¤è©²æ¨™ç±¤
          setSelectedTags((tags) => tags.filter((t) => t !== lastAction.tag));
        } else if (lastAction.type === 'remove') {
          // å¦‚æœæœ€å¾Œä¸€æ¬¡æ˜¯ç§»é™¤ï¼Œæ’¤éŠ·æ™‚è¦é‡æ–°åŠ å…¥è©²æ¨™ç±¤
          setSelectedTags((tags) => [...tags, lastAction.tag]);
        }

        // ç§»é™¤æ­·å²ç´€éŒ„ä¸­çš„æœ€å¾Œä¸€ç­†æ“ä½œï¼ˆç­‰åŒæ–¼ popï¼‰
        return prev.slice(0, -1);
      });
    }
  };

  window.addEventListener('keydown', handleKeyDown);

  return () => window.removeEventListener('keydown', handleKeyDown);
}, []);
```
````

<!--
é›–ç„¶å¯ä»¥å®ŒæˆåŠŸèƒ½ï¼Œä½†ä¹Ÿå¯ä»¥ç™¼ç¾æ•´å€‹é‚è¼¯éå¸¸è¤‡é›œï¼Œä½†æœ‰è »å¤šå•é¡Œåœ¨é€™è£¡é¢çš„

[click]

é¦–å…ˆï¼Œå°±åƒå‰é¢æåˆ°çš„ï¼Œstate æ˜¯ immutable çš„ï¼Œæ‰€ä»¥æ¯æ¬¡éƒ½è¦ç”¨ ...prev å±•é–‹é‹ç®—ç¬¦ ä¾†è¿”å›æ–°çš„é™£åˆ—ï¼Œé€™æ¨£çš„å¯«æ³•éå¸¸å†—é•·

[click]

å†ä¾†ï¼Œç‚ºäº†çŸ¥é“é€™æ¬¡è¿”å›çš„æ“ä½œæ˜¯é¸å–é‚„æ˜¯å–æ¶ˆé¸å–ï¼Œæˆ‘å€‘å¿…é ˆè¦åœ¨ setHistory è£¡é¢ï¼Œå†å»æ‰ç”¨ setSelectedTags ä¾†æ›´æ–°æ¨™ç±¤

é€™ç¨® setState åµŒå¥—çš„å¯«æ³•æ˜¯å¾ˆä¸å®¹æ˜“ç¶­è­·çš„

[click]

æœ€å¾Œæˆ‘å€‘é‚„è¦è¨˜å¾—ï¼Œè¦è¿”å›æ–°é™£åˆ—çµ¦ historyï¼Œå› ç‚º state æ˜¯ immutable çš„
æ‰€ä»¥é€™é‚Šè¦ return prev.slice(0, -1) è¿”å›åˆªé™¤æœ€å¾Œä¸€ç­†æ“ä½œå¾Œçš„æ–°é™£åˆ—
-->

---
layout: center
---

<h1 class="!text-6xl"> ç”¨ state æœ‰éå¸¸å¤šè¦æ³¨æ„çš„åœ°æ–¹ </h1>

<v-click>

**æ­·å²ç´€éŒ„æ ¹æœ¬ä¸å½±éŸ¿ç•«é¢å‘ˆç¾**ï¼Œåªæ˜¯å„²å­˜æ“ä½œé †åºè€Œå·²

é€™æ¨£çš„è³‡æ–™éå¸¸é©åˆä½¿ç”¨ `useRef` ä¾†å„²å­˜

</v-click>

<!--
æ‰€ä»¥ç”¨ state å¯¦ä½œçš„è©±ï¼Œæœ‰éå¸¸å¤šè¦æ³¨æ„çš„åœ°æ–¹

[click]
ä½†å›éé ­ä¾†æƒ³ï¼Œæ­·å²ç´€éŒ„æ ¹æœ¬ä¸å½±éŸ¿ç•«é¢å‘ˆç¾ï¼Œåªæ˜¯å„²å­˜æ“ä½œé †åºè€Œå·²ã€‚

é€™æ¨£çš„è³‡æ–™éå¸¸é©åˆä½¿ç”¨ useRef
-->

---

# æ›´å¥½çš„è§£æ³•ï¼šç”¨ useRef å„²å­˜è³‡æ–™

````md magic-move {lines: true}
```jsx {*|7-11,17-21}
const historyRef = useRef([]);

const handleTagClick = (tag) => {
  if (!selectedTags.includes(tag)) {
    setSelectedTags((prev) => [...prev, tag]);

    // è¨˜éŒ„æ–°å¢æ“ä½œåˆ°æ­·å²ä¸­
    historyRef.current.push({
      type: 'add',
      tag,
    });
  } else {
    setSelectedTags((prev) =>
      prev.filter((t) => t !== tag),
    );

    // è¨˜éŒ„ç§»é™¤æ“ä½œåˆ°æ­·å²ä¸­
    historyRef.current.push({
      type: 'remove',
      tag,
    });
  }
```

```jsx {*|7-8|10-15}
useEffect(() => {
  const handleKeyDown = (e) => {
    const isCtrlZ = (e.ctrlKey || e.metaKey) && e.key === 'z';

    if (isCtrlZ) {
      // å–å‡ºæœ€å¾Œä¸€æ¬¡æ“ä½œ
      const lastAction = historyRef.current.pop();
      if (!lastAction) return;

      // åŸ·è¡Œç›¸åæ“ä½œä¾†æ’¤éŠ·
      if (lastAction.type === 'add') {
        setSelectedTags((tags) => tags.filter((t) => t !== lastAction.tag));
      } else if (lastAction.type === 'remove') {
        setSelectedTags((tags) => [...tags, lastAction.tag]);
      }
    }
  };

  window.addEventListener('keydown', handleKeyDown);
  return () => window.removeEventListener('keydown', handleKeyDown);
}, []);
```
````

<!--
é‚£æˆ‘å€‘å¯ä»¥ä¾†æ€è€ƒä¸€ä¸‹æ€éº¼ç”¨ useRef å„ªåŒ–

[click]
é¦–å…ˆï¼Œæˆ‘å€‘ä¸ç”¨å†ç”¨ ...prev å±•é–‹é‹ç®—ç¬¦ä¾†è¿”å›æ–°çš„é™£åˆ—ï¼Œç›´æ¥ç”¨ push å³å¯

[click]
å†ä¾† useEffect çš„é‚è¼¯è®Šå¾—ç°¡å–®å¾ˆå¤š

[click]
åªè¦ç”¨ pop å–å‡ºæœ€å¾Œä¸€æ¬¡æ“ä½œï¼Œå°±å¯ä»¥æ ¹æ“š type ä¾†åŸ·è¡Œç›¸åçš„æ“ä½œ

[click]
ä¸éœ€è¦ setState åŒ… setState

ä¹Ÿä¸éœ€è¦ return æ–°çš„é™£åˆ—

æ•´å€‹é‚è¼¯æ¸…æ¥šå¾ˆå¤š

ref æ˜¯éå¸¸å¯¦ç”¨çš„ React å·¥å…·ï¼Œä¸åªæ˜¯ç”¨ä¾†æŠ“ DOMï¼Œä¹Ÿå¯ä»¥å„²å­˜è³‡æ–™
-->

---
layout: center
---

# æ€è€ƒè³‡æ–™æ˜¯å¦è·Ÿç•«é¢æœ‰é—œï¼Ÿ

<!--
é€™é‚Šä¹Ÿå±•ç¤ºäº†ä¸€å€‹åœ¨ React è »é—œéµæ€ç¶­ï¼šä¸æ˜¯æ‰€æœ‰è³‡æ–™éƒ½éœ€è¦ç”¨ state å„²å­˜ã€‚ç•¶è³‡æ–™è®Šå‹•èˆ‡ç•«é¢æ›´æ–°ç„¡é—œæ™‚ï¼Œä½¿ç”¨ ref ä¸åƒ…å¯ä»¥ç°¡åŒ–é‚è¼¯ï¼Œé‚„èƒ½æå‡æ•ˆèƒ½èˆ‡å¯ç¶­è­·æ€§ã€‚
-->

---

# Decision Tree

**è³‡æ–™çµæ§‹è¨­è¨ˆï¼Œæ˜¯è§£æ³•çš„æ ¹æœ¬**ï¼Œæ€è€ƒå“ªäº›å€¼éœ€è¦æ‹†é–‹ã€å“ªäº›å¯ä»¥æ•´åˆã€å“ªäº›ä¸éœ€è¦ state

<img src="/ch-2/decision-tree.png" alt="Decision Tree" class="w-[580px]">

<!--
æœ€å¾Œç¸½çµä¸€ä¸‹ï¼Œ

æ€è€ƒä½ çš„è³‡æ–™çµæ§‹è¨­è¨ˆï¼Œæ˜¯æŠŠç¨‹å¼å¯«ä¹¾æ·¨çš„æ ¹æœ¬

èŠ±é»æ™‚é–“è¨­è¨ˆä½ çš„è³‡æ–™çµæ§‹ï¼Œæƒ³æ¸…æ¥šã€Œå“ªäº›å€¼éœ€è¦æ‹†é–‹ã€å“ªäº›å¯ä»¥æ•´åˆã€å“ªäº›ä¸éœ€è¦ state ã€ï¼Œåè€Œèƒ½è®“ä½ çš„ç¨‹å¼ç¢¼é‚è¼¯è®Šå¾—æ›´ç°¡å–®ã€æ›´ç©©å®šã€‚

é€™é‚Šæˆ‘ä¹Ÿåšäº†ä¸€å€‹æ±ºç­–åœ–ï¼Œç¸½çµå‰é¢æåˆ°çš„

1. derived state
2. formData
3. state è¦æ‹†é–‹é‚„æ˜¯åˆåœ¨ä¸€èµ·
4. è¦ç”¨ useRef é‚„æ˜¯ useState

é€™å¼µåœ–æœƒæ”¾åœ¨èª²ç¨‹çš„è£œå……è³‡æºä¸­ï¼Œæ‰€ä»¥ä¹Ÿä¸ç”¨æ“”å¿ƒä¾†ä¸åŠçœ‹
-->
